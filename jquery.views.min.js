/*
 * jQuery Views Plugin v1.0pre
 * Interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string).
 * See JsRender at http://github.com/BorisMoore/jsrender
 * and JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var i,d,w,p={value:"val",html:"html",text:"text"},q="_jsvData",g={change:function(o){var m,l,c,h,g,j,i,k,n,t,e=this.target,f=o.target,r=a(f),s=this.links,u=s.length;while(u--&&!l){j=s[u];if(j.from&&a(f).is(j.from)){c=j.fromAttr;if(!c){c=d.merge[f.nodeName.toLowerCase()];c=c?c.from.fromAttr:"text"}m=p[c];g=a.isFunction(c)?c(f):m?r[m]():r.attr(c);if((!this.cb||!(l=this.cb(o)===false))&&g!==b){h=j.to;if(!h){var q=f.getAttribute(d.linkToAttr);if(q){t=/([\$\w\.]+)?(?:\((.*?)\))?(?:\[([\w\.]*)\])(?:\:\s*(\w+)\((.*?)\))?\s*$/;q.replace(t,function(m,b,l,g,d,c){if(b)e=window[b];else{n=a.view(f);e=n&&n.data||e}h=g;i=d||j.convert;k=c})}}if(e[i])g=e[i].call(e,g,f,h,e,k);else if(i=window[i])g=i(g,f,h,e,k);e&&a.observable(e).setField(h,g)}l&&o.stopImmediatePropagation()}}},objectChange:function(o,h){var j,q,e=this,k=e.target,i=a(k),n=o.target,r=e.inner||e.from||e.getFrom,f=e.toAttr,g=e.convert,c=h?h.value:u(n,r),l=h&&h.path,s=a.view(k);if((!e.cb||!(q=e.cb(o,h)===false))&&c!==b&&(!l||l===r)&&(!s||s.onDataChanged(h)!==false)){if(g)if(a.isFunction(g))c=g.call(e,c,n,l,k);else if(g=m(n,e.convert)||m(window,e.convert))c=g[0][g[1]].call(g[0],c);if(!f){f=d.merge[k.nodeName.toLowerCase()];f=f?f.to.toAttr:"text"}if(css=f.indexOf("css-")===0&&f.substr(4))i.css(css)!==c&&i.css(css,c);else{j=p[f];if(j&&i[j]()!==c)i[j](c);else i.attr(f)!==c&&i.attr(f,c)}}q&&o.stopImmediatePropagation()},arrayChange:function(e,a){var c,g=this.target,f=a?a.action:d.linkToAttr;if((!this.cb||!(c=this.cb(e,a)===false))&&f!==b)g.onDataChanged(a);c&&e.stopImmediatePropagation()}};function j(h,g,l,b,i,j,d){var f,e,c=this;a.extend(c,{views:[],nodes:h?[]:[document.body],tmpl:l||b&&b.tmpl,path:g,parent:b,prevNode:h});if(b){c.callback=j||b.callback;f=b.views;i.push(c);d=d||b.data;if(a.isArray(b.data)){c.index=e=g;f.splice(e,0,c);viewCount=f.length;d=d[e];while(e++<viewCount-1)a.observable(f[e]).setField("index",e)}else{if(g)d=new Function("$","$view","$data","with($data){ return "+g+";}")(a,b,d);c.index=f.length;f.push(c)}}c.data=d;k(c)}function f(g,p,k,r,w,m,v,s){function t(a,f){var i,d,b=m||p.data;a=a.split(/\:\s*/);if(a[1]){i=a[0];a[0]=a[1]}a=a[0];if(f){d=a;a=f}var c={target:g,toAttr:i,convert:d};a=a.split(/\[|\]/);if(a[1]){b=a[0]==="$view"?h:window[a[0]]||b;a[0]=a[1]}c[this]=a[0];e(b,g,k,c)}var l,x,n,A,z,i,u,y=k===false,h=p,q=w;k=k||p.callback;s=s||0;g=v||g;if(!v&&g.nodeType===1){q++===0&&h.nodes.push(g);o(g.getAttribute(d.getFromAttr),"getFrom",t);o(g.getAttribute(d.linkFromAttr),"from",t);g=g.firstChild}else g=g.nextSibling;while(g&&g!==r){if(g.nodeType===1)f(g,h,k,r,q,m);else if(g.nodeType===8&&(l=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(g.nodeValue)))if(l[1])if(l[2]){h.nextNode=g;h.onCreated(h);h=p}else{h.nextNode=g;h.onCreated(h);return g}else{n=n||c(g.parentNode,"view",true);if(l[2])h=new j(g,s++,b,h,n,k);else{i=a.view(g);if(i&&i.prevNode===g)if(i.data===m)u=i.nextNode;else{i.data=m;i.render();return i.nextNode}else i=new j(g,l[3],l[4],h,n,k,m);g=u||f(g,i,k,r,0)}}else q===0&&h.nodes.push(g);g=g.nextSibling}}function e(p,e,j,o,y){p=h(p);if(a.isFunction(e)){j=e;e=b}else e=h(e);var z,v,k,s,u,w=e,A=this,t=[],m=p[0],i=arguments.length-1;if(!j&&i>2&&a.isFunction(arguments[i])){j=arguments[i];arguments[i]=b}if(!m)return;u=m.nodeType;o=o?a.isArray(o)?o:[o]:[];i=o.length;if(y){if(u){p.each(function(){var a=c(this,"to");if(a.length){a=a[0];if(a===e[0])return;r(this,{target:a,cb:j,links:[{from:"input["+d.linkToAttr+"]"}]})}n(this,{target:e[0],cb:j,links:[{from:"input["+d.linkToAttr+"]"}]})});return}e.each(function(){f(this,a.view(this),j,b,b,m)});return}if(u){(i||j)&&p.each(function(){n(this,{target:e[0],cb:j,links:o})});return}if(i){while(i--){v=o[i];s=v.to;if(s)w=e.find(s).add(a(this).filter(s));w.each(function(){k=a.extend({source:m,target:this,cb:j},v);k.to=b;t.push(k)})}z=g.objectChange;i=t.length;while(i--){k=t[i];var q=m,x=k.getFrom;innerPath=(x||k.from).split("."),innerLinks=[];while(innerPath.length>1){q=q[innerPath.shift()];q&&l(q,a.extend({inner:innerPath.join(".")},k))}l(m,k,x)}return}j&&l(m,{source:m,target:e,cb:j})}function l(e,d,h){var f=d.target,b=function(){g.objectChange.apply(d,arguments)};c(f,"from",true).push({source:e,handler:b,inner:d.inner});a(e).bind("objectChange",b);h&&b({target:e});return b}function n(e,b){var f=b.target,d=function(){g.change.apply(b,arguments)};c(e,"to",true).push(f);a(e).bind("change",d);return d}function r(e,f){var b=c(e,"to"),d=b.length;while(d--)if(b[d]===f.target){a(e).unbind("change");b.splice(d,1)}}function k(b){var e,d=b.data,c=b._onArrayChange;if(c){if(c[1]===d)return;a([c[1]]).unbind("arrayChange",c[0])}if(a.isArray(d)){e=function(){g.arrayChange.apply({target:b,cb:b.callback},arguments)};a([d]).bind("arrayChange",e);b._onArrayChange=[e,d]}}function v(j,d){var h,f,b,g,e,i;c(d,"to").length&&a(d).unbind("change");f=c(d,"from"),b=f.length;while(b--){h=f[b];a(h.source).unbind("objectChange",h.handler)}g=c(d,"view");if(b=g.length){e=a.view(d);while(b--){i=g[b];i.parent===e&&e.removeViews(i.index,1)}}}function c(c,e,d){var b=a.data(c,q)||d&&a.data(c,q,{view:[],from:[],to:[]});return b?b[e]:[]}function o(c,e,f){if(c){var g,h,b,i,a=0,d=c.replace(/(\s*\,\s*)|(\(\s*)|(\s*\))/g,function(b,d,c){return d?a?b:"\r":c?a++?b:"\t":--a?b:"\t"}).split("\r");b=d.length;while(b--)f.apply(e,d[b].split("\t"))}}function h(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function u(b,e){if(b&&e){var c,d=m(b,e);b=d&&d[0];if(b){c=b[d[1]];return a.isFunction(c)?c.call(b):c}}return b}function m(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()]}return a&&a[b]&&[a,b]}function t(b){return b.type==="checkbox"?b.checked:a(b).val()}var s=a.cleanData;a.extend({cleanData:function(b){a(b).each(v);s(b)},link:function(g,c,f,d){if(a.isFunction(c)){d=c;c=b}else c=h(c);if(c&&c[0].nodeType)c.each(function(){e(g,this,d,f)});else h(g).each(function(){e(this,c,d,f)})},view:function(b,h){var d,k,f,l,g,e=document.body;b=b||e;if(!b.nodeType&&!h&&a.isPlainObject(b)){h=b;b=e}if(i&&!i.views.length)d=i;else{while(!(f=c(g=b.parentNode||e,"view")).length){if(!g||b===e){c(e.parentNode,"view",true).push(d=i=new j);break}b=g}if(!d&&b===e)d=f[0];while(!d&&b){if(b.nodeType===8&&/^item|tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(b.nodeValue)){l=f.length;while(l--){k=f[l];if(k.prevNode===b){d=k;break}}}b=b.previousSibling}d=d||a.view(g)}return h?a.extend(d,h):d},linkSettings:{linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:t},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,g=a.action,c=a.newIndex,e=a.oldIndex,d=a.newItems,f=a.oldItems;switch(g){case"add":b.addViews(c,d);break;case"remove":b.removeViews(e,f.length);break;case"move":b.refresh();break;case"reset":b.refresh()}}return true},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(){var h,g=a.render(this.tmpl,this.data),c=this.prevNode,e=this.nextNode,d=c.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(c).after(g);d.removeChild(c.nextSibling);d.removeChild(e.previousSibling);f(d,this,b,e,0,b,c,0);k(this);return this},addViews:function(e,g,l){var i=g.length,j=this.views;if(i){var k=a.render(l||this.tmpl,g),c=e?j[e-1].nextNode:this.prevNode,h=c.nextSibling,d=c.parentNode;a(c).after(k);d.removeChild(c.nextSibling);d.removeChild(h.previousSibling);f(d,this,b,h,0,b,c,e)}return this},removeViews:function(e,l,m){if(l){var g,j,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||c(d.nextNode.parentNode,"view");f=g.length;while(f--&&j===b)if(g[f]===d)j=f;g.splice(j,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=b;k(d)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setField("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}}});a.fn.extend({view:function(b){return a.view(this[0],b)},link:function(a,c){if(a){e(a,this,c,b,true);e(this,a,c,b,true)}return this},linkFrom:function(a,c,b){e(a,this,b,c);return this},linkTo:function(a,c,b){e(this,a,b,c);return this}});d=a.linkSettings;j.prototype=d.view;w=d.decl})(jQuery);
