/*
 * JsViews v1.0pre
 * jQuery plugin providing interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string)
 *    See JsRender at http://github.com/BorisMoore/jsrender
 * and jquery.observable.js.
 *    See JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var f=false,e=true,h,d,G,u={value:"val",html:"html",text:"text"},v="_jsvData";function z(p){var w,v,c,x,e,r,k,h,n,y,i,q=this.target,g=p.target,t=a(g),j=a.view(g);links=this.links,context=j.ctx,beforeChange=context.beforeChange,l=links.length;while(l--&&!v){h=links[l];if(!h.filter||h.filter&&t.is(h.filter)){c=h.fromAttr;if(!c){c=d.merge[g.nodeName.toLowerCase()];c=c?c.from.fromAttr:"text"}w=u[c];k=a.isFunction(c)?c(g):w?t[w]():t.attr(c);if((!beforeChange||!(v=beforeChange.call(j,p)===f))&&k!==b){e=h.to||a.trim(g.getAttribute(d.linkToAttr));if(e){n=h.convert;e=m(e);i=e[0].slice(0,-1);q=j&&j.data||q;i=s(q,j,i);n=e[3];x=a.trim(e[1].slice(0,-1));r={source:g,target:i,convert:n,path:x};if(n)k=o(r,q,j,n,k);if(i){a.observable(i).setProperty(x,k);context.afterChange&&context.afterChange.call(r,g,p)}p.stopPropagation()}}v&&p.stopImmediatePropagation()}}}function x(l,c){var p,h,w,g,b,j=this,i=j.target,e=a(i),s=l.target,v=c&&c.path||l.path,k=a.view(i),q=k.ctx,r=q.beforeChange,m=n(i,s).paths[v],t=m&&m.length;while(t--){p=m[t];if((!r||!(c&&(w=r.call(this,l,c)===f)))&&(!k||k.onDataChanged(c)!==f)){b=p.attr;sourceValue=o(j,j.source,k,p.expr,c&&c.value);if(a.isFunction(sourceValue))sourceValue=sourceValue.call(s);if(!b){b=d.merge[i.nodeName.toLowerCase()];b=b?b.to.toAttr:"text"}if(css=b.indexOf("css-")===0&&b.substr(4))(g=e.css(css)!==sourceValue)&&e.css(css,sourceValue);else{h=u[b];if(h)(g=e[h]()!==sourceValue)&&e[h](sourceValue);else(g=e.attr(b)!==sourceValue)&&e.attr(b,sourceValue)}c&&g&&q.afterChange&&q.afterChange.call(j,l,c)}}}function y(g,a){var i,c=this.ctx,e=c.beforeChange,h=a?a.change:d.linkToAttr;if((!e||!(i=e.call(this,g,a)===f))&&h!==b){this.onDataChanged(a);c.afterChange&&c.afterChange.call(this,g,a)}}function k(d){var e,c=d.data,b=d._onArrayChange;if(b){if(b[1]===c)return;a([b[1]]).unbind("arrayChange",b[0])}if(a.isArray(c)){e=function(){y.apply(d,arguments)};a([c]).bind("arrayChange",e);d._onArrayChange=[e,c]}}function t(d,c,f){var b=d.parent&&d.parent.ctx,e=d._ctx;d.ctx=f?e&&b?a.extend({},b,e):b||e:c&&c!==b?(d._ctx=c,b?a.extend({},b,c):c):b}function j(h,i,g,l,d,j,b){var f,e,c=this;a.extend(c,{views:[],nodes:i?[]:[document.body],tmpl:l||d&&d.tmpl,path:g,parent:d,prevNode:i});if(d){f=d.views;j.push(c);b=b||d.data;if(a.isArray(d.data)){c.index=e=g;f.splice(e,0,c);viewCount=f.length;b=b[e];while(e++<viewCount-1)a.observable(f[e]).setProperty("index",e)}else{if(g){b=p(b,d,g);h=h||b[1];b=b[0]}c.index=f.length;f.push(c)}}c.data=b;t(c,h);k(c)}function g(f,s,p,y,m,x,t,r){var l,z,n,B,A,i,w,k,h=s,o=y;t=t||0;f=x||f;if(!x&&f.nodeType===1){o++===0&&h.nodes.push(f);var u=f.getAttribute(d.linkFromAttr),v=f.getAttribute(d.getFromAttr);(u||v)&&q(m||s.data,f,v,u,e);f=f.firstChild}else f=f.nextSibling;while(f&&f!==p){if(f.nodeType===1)g(f,h,p,o,m);else if(f.nodeType===8&&(l=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(f.nodeValue))){k=f.parentNode;if(l[1]){if(k!==h.prevNode.parentNode){l[2]&&k.parentNode.insertBefore(f.nextSibling,k.nextSibling);k.parentNode.insertBefore(f,k.nextSibling);return}h.nextNode=f;h.ctx.afterCreate&&h.ctx.afterCreate.call(h,h);if(l[2])h=s;else return f}else{n=n||c(k,"view",e);if(l[2])h=new j(r,f,t++,b,h,n);else{i=a.view(f);if(i&&i.prevNode===f)if(i.data===m)w=i.nextNode;else{i.data=m;i.render(r);return i.nextNode}else i=new j(r,f,l[3],l[4],h,n,m);f=w||g(f,i,p,0)}}}else o===0&&h.nodes.push(f);f=f.nextSibling}}function p(d,b,c){return Function("$","$data","$view","$ctx","with($data){ return ["+c+"];}")(a,d,b,b.ctx)}function o(d,e,b,c,f){try{return Function("$","$data","$view","$ctx","$value","with($data){return "+c+";}").call(d,a,e,b,b.ctx,f)}catch(g){throw g.message;}}function s(c,d,b){try{return b?Function("$","$data","$view","$ctx","with($data){return "+b+";}")(a,c,d,d.ctx):c}catch(e){throw e.message;}}function w(f,k,e,n){if(e){e=a.isArray(e)?e:[e];var d,j,m,h=[],l=[];i=e.length;while(i--){d=e[i];d.to&&h.push({to:d.to,filter:d.filter});(d.from||d.getFrom)&&l.push(d)}i=l.length;while(i--){d=l[i];j=d.filter;m=j?f.find(j).add(a(this).filter(j)):f;m.each(function(){q(k,this,d.getFrom,d.from)})}}(!e||h.length)&&f.each(function(){if(!e){var i=c(this,"to");i=i.length;while(i--){d=i[i];if(d.links===declLinkTo){if(d.target===k)return;A(this,d.target,declLinkTo);i.splice(i,1)}}h=declLinkTo;f.each(function(){g(this,a.view(this),b,b,k,b,b,n)})}B(this,k,h)});return f}function q(w,x,t,l){var b,d,h,g,j,p,i,B,o,f,A,k=[],c="";l=m((l?l+",":"")+(t?"|,"+t+",":""),e);while(b=l.shift()){g=b.length;j=b.charAt(g-1);b=b.slice(0,-1);switch(j){case":":p=a.trim(b);break;case"[":c=a.trim(b);break;case")":c=c||b;break;case"]":k=[[c,b]];c=c?c+"."+b:b;break;case"\r":i=++b;break;case",":if(b==="|"){B=e;continue}if(i){f=c.slice(i);f=m(f);for(h=0,g=f.length;h<g;h++){d=a.trim(f[h]);j=d.charAt(d.length-1);d=d.slice(0,-1);if(j==="[")f[h]=o=d;else if(j==="]"){k.push([o,d]);f[h]=o?"."+d:d;o=""}}c=c.slice(0,i)+f.join("")+")"}c+=b;A=a.view(x);g=k.length;while(g--){var u=k[g],z=u[1],v=s(w,A,u[0]),y={source:w,target:x},q=z.split("."),n=v;while(q.length>1){n=n[q.shift()];n&&r(n,y,q.join("."),c,p)}r(v,y,z,c,p,!g&&B)}i=0;k=[];p=c=""}}}function r(d,k,f,m,l,o){var h,i,g=k.target,b=n(g,d),j={attr:l,expr:m};if(b){i=b.paths[f]=b.paths[f]||[];i.push(j);handler=b.handler}else{handler=function(){x.apply(k,arguments)};if(g){h={};h[f]=[j];c(g,"from",e).push({source:d,paths:h,handler:handler})}a(d).bind("propertyChange",handler)}o&&handler({target:d,path:f})}function B(d,f,g){var b=function(){z.apply({target:f,links:g},arguments)};c(d,"to",e).push({target:f,links:g,handler:b});a(d).bind("change",b)}function A(e,g,h){var b,d=c(e,"to"),f=d.length;while(f--){b=d[f];b.target===g&&b.links===h&&a(e).unbind("change",b.handler)}}function n(e,d){var a,b=c(e,"from");l=b.length;while(l--){a=b[l];if(a.source===d)return a}}function F(j,d){var h,f,b,g,e,i;c(d,"to").length&&a(d).unbind("change");f=c(d,"from"),b=f.length;while(b--){h=f[b];a(h.source).unbind("propertyChange",h.handler)}g=c(d,"view");if(b=g.length){e=a.view(d);while(b--){i=g[b];i.parent===e&&e.removeViews(i.index,1)}}}function c(c,e,d){var b=a.data(c,v)||d&&a.data(c,v,{view:[],from:[],to:[]});return b?b[e]:[]}function m(a,h){var c,d=0,b=0,g=f,e=f;a=a.replace(/\s+/g," ");return a.replace(/(\))|([\:\,])|(\')|(\")|([\(\[\{])|([\}\]])/g,function(f,o,n,j,k,m,l,i){if(e){e=!j;return f}if(g){g=!k;return f}if(o)return--b?f:h&&a.charAt(i+1)===","?(c-=d,d=i,f+"\t"+c+"\r\t"):f;if(n)return b?f:(d=i+1,f+"\t");if(m){if(b++)return f;if(f==="(")c=i;return f!=="["?f:"[\t"}if(l)return--b||f!=="]"?f:"]\t";e=j;g=k;return f}).split("\t")}function E(b){return b.type==="checkbox"?b.checked:a(b).val()}var D=a.cleanData;a.extend({view:function(b){var d,g,f,i,l,k=document.body;b=b||k;if(h&&!h.views.length)d=h;else{while(!(f=c(l=b.parentNode||k,"view")).length){if(!l||b===k){c(k.parentNode,"view",e).push(d=h=new j);h.ctx={};break}b=l}if(!d&&b===k)d=f[0];while(!d&&b){if(b.nodeType===8)if(/^\/item|^\/tmpl$/.test(b.nodeValue)){i=f.length;while(i--){g=f[i];if(g.nextNode===b){b=g.prevNode;break}}}else if(/^item|^tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(b.nodeValue)){i=f.length;while(i--){g=f[i];if(g.prevNode===b){d=g;break}}}b=b.previousSibling}d=d||a.view(l)}return d},linkSettings:{getProperty:function(c,b){return a.isFunction(b)?b.call(c):b},linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:E},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,f=a.change,c=a.index,g=a.oldIndex,d=a.items;switch(f){case"insert":b.addViews(c,d);break;case"remove":b.removeViews(c,d.length);break;case"move":b.render();break;case"refresh":b.render()}}return e},render:function(){var h,f=a.render(this.tmpl,this.data,this.ctx),c=this.prevNode,e=this.nextNode,d=c.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(c).after(f);d.removeChild(c.nextSibling);d.removeChild(e.previousSibling);g(d,this,e,0,b,c,0);k(this);return this},addViews:function(h,i,o){var f,l=i.length,k=this.ctx,m=this.views;if(l){if(this.path){f=this.parent;k=p(f.data,f,this.path)[1]}var n=a.render(o||this.tmpl,i,k,this,e),c=h?m[h-1].nextNode:this.prevNode,j=c.nextSibling,d=c.parentNode;a(c).after(n);d.removeChild(c.nextSibling);d.removeChild(j.previousSibling);g(d,this,j,0,b,c,h)}return this},removeViews:function(e,l,m){if(l){var g,j,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||c(d.nextNode.parentNode,"view");f=g.length;while(f--&&j===b)if(g[f]===d)j=f;g.splice(j,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=b;k(d)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setProperty("index",e++)}return this},context:function(c){var a=this,d=a.parent,e=d?d.ctx:{};if(!c)a.each(function(a){a.ctx=e;a._ctx=b});else c!==a.ctx&&a.each(function(b){t(b,c,b!==a)});return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}},cleanData:function(b){a(b).each(F);D(b)}});a.fn.extend({view:function(){return a.view(this[0])},addLinks:function(c,b,a){return w(this,c,b,a)},removeLinks:function(){},link:function(e,c,d){if(a.isPlainObject(c))d=c;else{c=a.template(c);if(c){this.empty();e&&this.append(a.render(c,e,d))}}return w(this,e,b,d)}});d=a.linkSettings;j.prototype=d.view;G=d.decl;declLinkTo=[{filter:"input["+d.linkToAttr+"]"}]})(jQuery);