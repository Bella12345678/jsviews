/*
 * JsViews v1.0pre
 * jQuery plugin providing interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string)
 *    See JsRender at http://github.com/BorisMoore/jsrender
 * and jquery.observable.js.
 *    See JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,c){var f=false,e=true,h,d,C,q={value:"val",html:"html",text:"text"},r="_jsvData";function v(o){var s,r,b,t,g,j,h,k,n,x,e,l=this.target,i=o.target,p=a(i),v=this.links,u=this.options.beforeChange,w=v.length;while(w--&&!r){h=v[w];if(!h.filter||h.filter&&p.is(h.filter)){b=h.fromAttr;if(!b){b=d.merge[i.nodeName.toLowerCase()];b=b?b.from.fromAttr:"text"}s=q[b];j=a.isFunction(b)?b(i):s?p[s]():p.attr(b);if((!u||!(r=u(o)===f))&&j!==c){g=h.to||a.trim(i.getAttribute(d.linkToAttr));if(g){k=h.convert;g=m(g);e=g[0].slice(0,-1);n=a.view(i);l=n&&n.data||l;e=e?(e=Function("$","$data","$view","with($data){return "+e+";}")(a,l,n)):l;t=a.trim(g[1].slice(0,-1));k=g[3];if(k)try{j=Function("$","$data","$view","$value","with($.linkSettings.converters){return "+k+";}").call({source:i,target:e,convert:k,path:t,options:this.options},a,l,n,j)}catch(y){throw y.message;}if(e){a.observable(e).setProperty(t,j);this.options.afterChange&&this.options.afterChange(o)}o.stopPropagation()}}r&&o.stopImmediatePropagation()}}}function t(k,c){var m,i,v,h,b,p,g=this,j=g.target,e=a(j),t=k.target,u=c&&c.path||k.path,o=g.options||{},s=o.beforeChange,r=a.view(j);pathInfos=n(j,t).paths[u],l=pathInfos&&pathInfos.length;while(l--){m=pathInfos[l];if((!s||!(c&&(v=s.call(this,k,c)===f)))&&(!r||r.onDataChanged(c)!==f)){b=m.attr,p=m.convert;if(p){try{sourceValue=Function("$","$data","$view","with($.linkSettings.converters){with($data){return "+p+";}}").call(g,a,g.source,r)}catch(w){throw w.message;}if(a.isFunction(sourceValue))sourceValue=sourceValue.call(t)}if(!b){b=d.merge[j.nodeName.toLowerCase()];b=b?b.to.toAttr:"text"}if(css=b.indexOf("css-")===0&&b.substr(4))(h=e.css(css)!==sourceValue)&&e.css(css,sourceValue);else{i=q[b];if(i)(h=e[i]()!==sourceValue)&&e[i](sourceValue);else(h=e.attr(b)!==sourceValue)&&e.attr(b,sourceValue)}c&&h&&o.afterChange&&o.afterChange.call(g,k,c)}}}function u(g,a){var i,j=this.target,b=this.options||{},e=b.beforeChange,h=a?a.change:d.linkToAttr;if((!e||!(i=e(g,a)===f))&&h!==c){j.onDataChanged(a);b.afterChange&&b.afterChange(g,a)}}function k(d,f){var e,c=d.data,b=d._onArrayChange;if(b){if(b[1]===c)return;a([b[1]]).unbind("arrayChange",b[0])}if(a.isArray(c)){e=function(){u.apply({target:d,options:f},arguments)};a([c]).bind("arrayChange",e);d._onArrayChange=[e,c]}}function j(l,h,g,j,b,i,d){var f,e,c=this;a.extend(c,{views:[],nodes:h?[]:[document.body],tmpl:j||b&&b.tmpl,path:g,parent:b,prevNode:h});if(b){f=b.views;i.push(c);d=d||b.data;if(a.isArray(b.data)){c.index=e=g;f.splice(e,0,c);viewCount=f.length;d=d[e];while(e++<viewCount-1)a.observable(f[e]).setProperty("index",e)}else{if(g)d=Function("$","$data","$view","with($data){ return "+g+";}")(a,d,b);c.index=f.length;f.push(c)}}c.data=d;k(c,l)}function g(f,q,l,s,y,n,x,t){var m,z,p,B,A,i,w,k,h=q,r=y;l=l||q.options;t=t||0;f=x||f;if(!x&&f.nodeType===1){r++===0&&h.nodes.push(f);var u=f.getAttribute(d.linkFromAttr),v=f.getAttribute(d.getFromAttr);(u||v)&&o(n||q.data,f,v,u,l,e);f=f.firstChild}else f=f.nextSibling;while(f&&f!==s){if(f.nodeType===1)g(f,h,l,s,r,n);else if(f.nodeType===8&&(m=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(f.nodeValue))){k=f.parentNode;if(m[1]){if(k!==h.prevNode.parentNode){m[2]&&k.parentNode.insertBefore(f.nextSibling,k.nextSibling);k.parentNode.insertBefore(f,k.nextSibling);return}if(m[2]){h.nextNode=f;h.onCreated(h);h=q}else{h.nextNode=f;h.onCreated(h);return f}}else{p=p||b(k,"view",e);if(m[2])h=new j(l,f,t++,c,h,p);else{i=a.view(f);if(i&&i.prevNode===f)if(i.data===n)w=i.nextNode;else{i.data=n;i.render();return i.nextNode}else i=new j(l,f,m[3],m[4],h,p,n);f=w||g(f,i,l,s,0)}}}else r===0&&h.nodes.push(f);f=f.nextSibling}}function s(h,l,e,f){f=a.isFunction(f)?{beforeChange:f}:f||{};if(e){e=a.isArray(e)?e:[e];var d,k,n,j=[],m=[];i=e.length;while(i--){d=e[i];d.to&&j.push({to:d.to,filter:d.filter});(d.from||d.getFrom)&&m.push(d)}i=m.length;while(i--){d=m[i];k=d.filter;n=k?h.find(k).add(a(this).filter(k)):h;n.each(function(){o(l,this,d.getFrom,d.from,f)})}}(!e||j.length)&&h.each(function(){if(!e){var i=b(this,"to");i=i.length;while(i--){d=i[i];if(d.links===declLinkTo){if(d.target===l)return;w(this,d.target,declLinkTo);i.splice(i,1)}}j=declLinkTo;h.each(function(){g(this,a.view(this,f),f,c,c,l)})}x(this,l,j,f)});return h}function o(s,v,t,k,A){var b,g,f,i,o,c,h,z,n,d,y,j=[];k=m((k?k+",":"")+(t?"|,"+t+",":""),e);while(b=k.shift()){f=b.length;i=b.charAt(f-1);b=b.slice(0,-1);switch(i){case":":o=a.trim(b);break;case"[":c=a.trim(b);break;case")":c=c||b;break;case"]":j=[[c,b]];c=c?c+"."+b:b;break;case"\r":h=++b;break;case",":if(b==="|"){z=e;continue}if(h){d=c.slice(h);d=m(d);for(g=0,f=d.length;g<f;g++){b=a.trim(d[g]);i=b.charAt(b.length-1);b=b.slice(0,-1);if(i==="[")d[g]=n=b;else if(i==="]"){j.push([n,b]);d[g]=n?"."+b:b;n=""}}c=c.slice(0,h)+d.join("")+")"}y=a.view(v);f=j.length;while(f--){var r=j[f],x=r[1],u=r[0]?Function("$","$data","$view","with($data){return "+r[0]+";}")(a,s,y):s,w={source:s,target:v,options:A},q=x.split("."),l=u;while(q.length>1){l=l[q.shift()];l&&p(l,w,q.join("."),c,o)}p(u,w,x,c,o,!f&&z)}h=0;j=[];o=c=""}}}function p(d,k,f,l,m,o){var h,i,g=k.target,c=n(g,d),j={attr:m,convert:l};if(c){i=c.paths[f]=c.paths[f]||[];i.push(j);handler=c.handler}else{handler=function(){t.apply(k,arguments)};if(g){h={};h[f]=[j];b(g,"from",e).push({source:d,paths:h,handler:handler})}a(d).bind("propertyChange",handler)}o&&handler({target:d,path:f})}function x(d,f,g,h){var c=function(){v.apply({target:f,links:g,options:h},arguments)};b(d,"to",e).push({target:f,links:g,handler:c});a(d).bind("change",c)}function w(e,g,h){var c,d=b(e,"to"),f=d.length;while(f--){c=d[f];c.target===g&&c.links===h&&a(e).unbind("change",c.handler)}}function n(f,e){var a,d,c=b(f,"from");l=c.length;while(l--){a=c[l];if(a.source===e)d=a}return d}function B(j,d){var h,f,c,g,e,i;b(d,"to").length&&a(d).unbind("change");f=b(d,"from"),c=f.length;while(c--){h=f[c];a(h.source).unbind("propertyChange",h.handler)}g=b(d,"view");if(c=g.length){e=a.view(d);while(c--){i=g[c];i.parent===e&&e.removeViews(i.index,1)}}}function b(c,e,d){var b=a.data(c,r)||d&&a.data(c,r,{view:[],from:[],to:[]});return b?b[e]:[]}function m(a,h){var c,d=0,b=0,g=f,e=f;a=a.replace(/\s+/g," ");return a.replace(/(\))|([\:\,])|(\')|(\")|([\(\[\{])|([\}\]])/g,function(f,o,n,j,k,m,l,i){if(e){e=!j;return f}if(g){g=!k;return f}if(o)return--b?f:h&&a.charAt(i+1)===","?(c-=d,d=i,f+"\t"+c+"\r\t"):f;if(n)return b?f:(d=i+1,f+"\t");if(m){if(b++)return f;if(f==="(")c=i;return f!=="["?f:"[\t"}if(l)return--b||f!=="]"?f:"]\t";e=j;g=k;return f}).split("\t")}function A(b){return b.type==="checkbox"?b.checked:a(b).val()}var z=a.cleanData;a.extend({view:function(c,l){var d,i,f,k,m,g=document.body;c=c||g;if(!c.nodeType&&!l&&a.isPlainObject(c)){l=c;c=g}if(h&&!h.views.length)d=h;else{while(!(f=b(m=c.parentNode||g,"view")).length){if(!m||c===g){b(g.parentNode,"view",e).push(d=h=new j(l));break}c=m}if(!d&&c===g)d=f[0];while(!d&&c){if(c.nodeType===8)if(/^\/item|^\/tmpl$/.test(c.nodeValue)){k=f.length;while(k--){i=f[k];if(i.nextNode===c){c=i.prevNode;break}}}else if(/^item|^tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(c.nodeValue)){k=f.length;while(k--){i=f[k];if(i.prevNode===c){d=i;break}}}c=c.previousSibling}d=d||a.view(m)}return l?a.extend(d,l):d},linkSettings:{getProperty:function(c,b){return a.isFunction(b)?b.call(c):b},converters:{},linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:A},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,f=a.change,c=a.index,g=a.oldIndex,d=a.items;switch(f){case"insert":b.addViews(c,d);break;case"remove":b.removeViews(c,d.length);break;case"move":b.render();break;case"refresh":b.render()}}return e},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(f){var i,h=a.render(this.tmpl,this.data),b=this.prevNode,e=this.nextNode,d=b.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(b).after(h);d.removeChild(b.nextSibling);d.removeChild(e.previousSibling);g(d,this,f,e,0,c,b,0);k(this,f);return this},addViews:function(e,f,m,j){var i=f.length,k=this.views;if(i){var l=a.render(m||this.tmpl,f),b=e?k[e-1].nextNode:this.prevNode,h=b.nextSibling,d=b.parentNode;a(b).after(l);d.removeChild(b.nextSibling);d.removeChild(h.previousSibling);g(d,this,j,h,0,c,b,e)}return this},removeViews:function(e,l,m,q){if(l){var g,j,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||b(d.nextNode.parentNode,"view");f=g.length;while(f--&&j===c)if(g[f]===d)j=f;g.splice(j,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=c;k(d,q)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setProperty("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}},cleanData:function(b){a(b).each(B);z(b)}});a.fn.extend({view:function(b){return a.view(this[0],b)},addLinks:function(c,b,a){return s(this,c,b,a)},removeLinks:function(){},link:function(e,b,d){if(typeof b==="string"){b=a.template(b);b&&this.empty().append(a.render(b,e))}else d=b;return s(this,e,c,d)}});d=a.linkSettings;j.prototype=d.view;C=d.decl;declLinkTo=[{filter:"input["+d.linkToAttr+"]"}]})(jQuery);