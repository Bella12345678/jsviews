/*
 * JsViews v1.0pre
 * jQuery plugin providing interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string)
 *    See JsRender at http://github.com/BorisMoore/jsrender
 * and jquery.observable.js.
 *    See JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,c){var f=false,e=true,h,d,C,q={value:"val",html:"html",text:"text"},r="_jsvData";function v(o){var t,s,b,u,g,j,h,k,n,y,e,l=this.target,i=o.target,p=a(i),w=this.links,r=this.options||{},v=r.beforeChange,x=w.length;while(x--&&!s){h=w[x];if(!h.filter||h.filter&&p.is(h.filter)){b=h.fromAttr;if(!b){b=d.merge[i.nodeName.toLowerCase()];b=b?b.from.fromAttr:"text"}t=q[b];j=a.isFunction(b)?b(i):t?p[t]():p.attr(b);if((!v||!(s=v(o)===f))&&j!==c){g=h.to||a.trim(i.getAttribute(d.linkToAttr));if(g){k=h.convert;g=m(g);e=g[0].slice(0,-1);n=a.view(i);l=n&&n.data||l;e=e?(e=Function("$","$data","$view","with($data){return "+e+";}")(a,l,n)):l;u=a.trim(g[1].slice(0,-1));k=g[3];if(k)try{j=Function("$","$data","$view","$value","with($.linkSettings.converters){return "+k+";}").call({source:i,target:e,convert:k,path:u},a,l,n,j)}catch(z){throw z.message;}if(e){a.observable(e).setProperty(u,j);r.afterChange&&r.afterChange(o)}o.stopPropagation()}}s&&o.stopImmediatePropagation()}}}function t(k,c){var m,i,v,h,b,p,g=this,j=g.target,e=a(j),t=k.target,u=c&&c.path||k.path,o=g.options||{},s=o.beforeChange,r=a.view(j);pathInfos=n(j,t).paths[u],l=pathInfos&&pathInfos.length;while(l--){m=pathInfos[l];if((!s||!(c&&(v=s.call(this,k,c)===f)))&&(!r||r.onDataChanged(c)!==f)){b=m.attr,p=m.convert;if(p){try{sourceValue=Function("$","$data","$view","with($.linkSettings.converters){with($data){return "+p+";}}").call(g,a,g.source,r)}catch(w){throw w.message;}if(a.isFunction(sourceValue))sourceValue=sourceValue.call(t)}if(!b){b=d.merge[j.nodeName.toLowerCase()];b=b?b.to.toAttr:"text"}if(css=b.indexOf("css-")===0&&b.substr(4))(h=e.css(css)!==sourceValue)&&e.css(css,sourceValue);else{i=q[b];if(i)(h=e[i]()!==sourceValue)&&e[i](sourceValue);else(h=e.attr(b)!==sourceValue)&&e.attr(b,sourceValue)}c&&h&&o.afterChange&&o.afterChange.call(g,k,c)}}}function u(g,a){var i,b=this.options,e=b.beforeChange,h=a?a.change:d.linkToAttr;if((!e||!(i=e(g,a)===f))&&h!==c){this.onDataChanged(a);b.afterChange&&b.afterChange(g,a)}}function k(d){var e,c=d.data,b=d._onArrayChange;if(b){if(b[1]===c)return;a([b[1]]).unbind("arrayChange",b[0])}if(a.isArray(c)){e=function(){u.apply(d,arguments)};a([c]).bind("arrayChange",e);d._onArrayChange=[e,c]}}function j(l,h,g,j,d,i,b){var f,e,c=this;a.extend(c,{options:l||{},views:[],nodes:h?[]:[document.body],tmpl:j||d&&d.tmpl,path:g,parent:d,prevNode:h});if(d){f=d.views;i.push(c);b=b||d.data;if(a.isArray(d.data)){c.index=e=g;f.splice(e,0,c);viewCount=f.length;b=b[e];while(e++<viewCount-1)a.observable(f[e]).setProperty("index",e)}else{if(g){b=Function("$","$data","$view","with($data){ return ["+g+"];}")(a,b,d);b[1]&&a.extend(c,b[1]);b=b[0]}c.index=f.length;f.push(c)}}c.data=b;k(c)}function g(f,q,k,s,y,n,x,t){var m,z,p,B,A,i,w,l,h=q,r=y;k=k||q.options;t=t||0;f=x||f;if(!x&&f.nodeType===1){r++===0&&h.nodes.push(f);var u=f.getAttribute(d.linkFromAttr),v=f.getAttribute(d.getFromAttr);(u||v)&&o(n||q.data,f,v,u,k,e);f=f.firstChild}else f=f.nextSibling;while(f&&f!==s){if(f.nodeType===1)g(f,h,k,s,r,n);else if(f.nodeType===8&&(m=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(f.nodeValue))){l=f.parentNode;if(m[1]){if(l!==h.prevNode.parentNode){m[2]&&l.parentNode.insertBefore(f.nextSibling,l.nextSibling);l.parentNode.insertBefore(f,l.nextSibling);return}if(m[2]){h.nextNode=f;h.onCreated(h);h=q}else{h.nextNode=f;h.onCreated(h);return f}}else{p=p||b(l,"view",e);if(m[2])h=new j(k,f,t++,c,h,p);else{i=a.view(f);if(i&&i.prevNode===f)if(i.data===n)w=i.nextNode;else{i.data=n;i.render(k);return i.nextNode}else i=new j(k,f,m[3],m[4],h,p,n);f=w||g(f,i,k,s,0)}}}else r===0&&h.nodes.push(f);f=f.nextSibling}}function s(h,l,e,f){f=a.isFunction(f)?{beforeChange:f}:f||{};if(e){e=a.isArray(e)?e:[e];var d,k,n,j=[],m=[];i=e.length;while(i--){d=e[i];d.to&&j.push({to:d.to,filter:d.filter});(d.from||d.getFrom)&&m.push(d)}i=m.length;while(i--){d=m[i];k=d.filter;n=k?h.find(k).add(a(this).filter(k)):h;n.each(function(){o(l,this,d.getFrom,d.from,f)})}}(!e||j.length)&&h.each(function(){if(!e){var i=b(this,"to");i=i.length;while(i--){d=i[i];if(d.links===declLinkTo){if(d.target===l)return;w(this,d.target,declLinkTo);i.splice(i,1)}}j=declLinkTo;h.each(function(){g(this,a.view(this,f),f,c,c,l)})}x(this,l,j,f)});return h}function o(t,w,u,l,B){var b,d,h,g,j,q,c,i,A,o,f,z,k=[];l=m((l?l+",":"")+(u?"|,"+u+",":""),e);while(b=l.shift()){g=b.length;j=b.charAt(g-1);b=b.slice(0,-1);switch(j){case":":q=a.trim(b);break;case"[":c=a.trim(b);break;case")":c=c||b;break;case"]":k=[[c,b]];c=c?c+"."+b:b;break;case"\r":i=++b;break;case",":if(b==="|"){A=e;continue}if(i){f=c.slice(i);f=m(f);for(h=0,g=f.length;h<g;h++){d=a.trim(f[h]);j=d.charAt(d.length-1);d=d.slice(0,-1);if(j==="[")f[h]=o=d;else if(j==="]"){k.push([o,d]);f[h]=o?"."+d:d;o=""}}c=c.slice(0,i)+f.join("")+")"}c+=b;z=a.view(w);g=k.length;while(g--){var s=k[g],y=s[1],v=s[0]?Function("$","$data","$view","with($data){return "+s[0]+";}")(a,t,z):t,x={source:t,target:w,options:B},r=y.split("."),n=v;while(r.length>1){n=n[r.shift()];n&&p(n,x,r.join("."),c,q)}p(v,x,y,c,q,!g&&A)}i=0;k=[];q=c=""}}}function p(d,k,f,l,m,o){var h,i,g=k.target,c=n(g,d),j={attr:m,convert:l};if(c){i=c.paths[f]=c.paths[f]||[];i.push(j);handler=c.handler}else{handler=function(){t.apply(k,arguments)};if(g){h={};h[f]=[j];b(g,"from",e).push({source:d,paths:h,handler:handler})}a(d).bind("propertyChange",handler)}o&&handler({target:d,path:f})}function x(d,f,g,h){var c=function(){v.apply({target:f,links:g,options:h},arguments)};b(d,"to",e).push({target:f,links:g,handler:c});a(d).bind("change",c)}function w(e,g,h){var c,d=b(e,"to"),f=d.length;while(f--){c=d[f];c.target===g&&c.links===h&&a(e).unbind("change",c.handler)}}function n(f,e){var a,d,c=b(f,"from");l=c.length;while(l--){a=c[l];if(a.source===e)d=a}return d}function B(j,d){var h,f,c,g,e,i;b(d,"to").length&&a(d).unbind("change");f=b(d,"from"),c=f.length;while(c--){h=f[c];a(h.source).unbind("propertyChange",h.handler)}g=b(d,"view");if(c=g.length){e=a.view(d);while(c--){i=g[c];i.parent===e&&e.removeViews(i.index,1)}}}function b(c,e,d){var b=a.data(c,r)||d&&a.data(c,r,{view:[],from:[],to:[]});return b?b[e]:[]}function m(a,h){var c,d=0,b=0,g=f,e=f;a=a.replace(/\s+/g," ");return a.replace(/(\))|([\:\,])|(\')|(\")|([\(\[\{])|([\}\]])/g,function(f,o,n,j,k,m,l,i){if(e){e=!j;return f}if(g){g=!k;return f}if(o)return--b?f:h&&a.charAt(i+1)===","?(c-=d,d=i,f+"\t"+c+"\r\t"):f;if(n)return b?f:(d=i+1,f+"\t");if(m){if(b++)return f;if(f==="(")c=i;return f!=="["?f:"[\t"}if(l)return--b||f!=="]"?f:"]\t";e=j;g=k;return f}).split("\t")}function A(b){return b.type==="checkbox"?b.checked:a(b).val()}var z=a.cleanData;a.extend({view:function(c,m){var d,i,f,k,l,g=document.body;c=c||g;if(!c.nodeType&&!m&&a.isPlainObject(c)){m=c;c=g}if(h&&!h.views.length)d=h;else{while(!(f=b(l=c.parentNode||g,"view")).length){if(!l||c===g){b(g.parentNode,"view",e).push(d=h=new j(m));break}c=l}if(!d&&c===g)d=f[0];while(!d&&c){if(c.nodeType===8)if(/^\/item|^\/tmpl$/.test(c.nodeValue)){k=f.length;while(k--){i=f[k];if(i.nextNode===c){c=i.prevNode;break}}}else if(/^item|^tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(c.nodeValue)){k=f.length;while(k--){i=f[k];if(i.prevNode===c){d=i;break}}}c=c.previousSibling}d=d||a.view(l)}return d},linkSettings:{getProperty:function(c,b){return a.isFunction(b)?b.call(c):b},converters:{},linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:A},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,f=a.change,c=a.index,g=a.oldIndex,d=a.items;switch(f){case"insert":b.addViews(c,d);break;case"remove":b.removeViews(c,d.length);break;case"move":b.render();break;case"refresh":b.render()}}return e},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(){var h,f=a.render(this.tmpl,this.data),b=this.prevNode,e=this.nextNode,d=b.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(b).after(f);d.removeChild(b.nextSibling);d.removeChild(e.previousSibling);g(d,this,this.options,e,0,c,b,0);k(this);return this},addViews:function(e,f,l){var i=f.length,j=this.views;if(i){var k=a.render(l||this.tmpl,f,this.options),b=e?j[e-1].nextNode:this.prevNode,h=b.nextSibling,d=b.parentNode;a(b).after(k);d.removeChild(b.nextSibling);d.removeChild(h.previousSibling);g(d,this,this.options,h,0,c,b,e)}return this},removeViews:function(e,l,m){if(l){var g,j,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||b(d.nextNode.parentNode,"view");f=g.length;while(f--&&j===c)if(g[f]===d)j=f;g.splice(j,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=c;k(d)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setProperty("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}},cleanData:function(b){a(b).each(B);z(b)}});a.fn.extend({view:function(b){return a.view(this[0],b)},addLinks:function(c,b,a){return s(this,c,b,a)},removeLinks:function(){},link:function(e,b,d){if(a.isPlainObject(b))d=b;else{b=a.template(b);b&&this.empty().append(a.render(b,e,d))}return s(this,e,c,d)}});d=a.linkSettings;j.prototype=d.view;C=d.decl;declLinkTo=[{filter:"input["+d.linkToAttr+"]"}]})(jQuery);