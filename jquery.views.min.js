/*
 * JsViews v1.0pre
 * jQuery plugin providing interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string)
 *    See JsRender at http://github.com/BorisMoore/jsrender
 * and jquery.observable.js.
 *    See JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var f=false,e=true,h,d,E,B=a.cleanData,t={value:"val",html:"html",text:"text"},u="_jsvData";function y(o){var w,v,c,x,e,q,h,g,m,j,p=this.target,i=o.target,s=a(i),l=a.view(i),z=this.links,u=l.ctx,y=u.beforeChange,A=z.length;while(A--&&!v){g=z[A];if(!g.filter||g.filter&&s.is(g.filter)){c=g.fromAttr;if(!c){c=d.merge[i.nodeName.toLowerCase()];c=c?c.from.fromAttr:"text"}w=t[c];h=a.isFunction(c)?c(i):w?s[w]():s.attr(c);if((!y||!(v=y.call(l,o)===f))&&h!==b){e=g.to||a.trim(i.getAttribute(d.linkToAttr));if(e){m=g.convert;e=k(e);j=e[0].slice(0,-1);p=l&&l.data||p;j=r(p,l,j);m=e[3];x=a.trim(e[1].slice(0,-1));q={source:i,target:j,convert:m,path:x};if(m)h=n(q,p,l,m,h);if(h!==b&&j){a.observable(j).setProperty(x,h);u.afterChange&&u.afterChange.call(q,o)}o.stopPropagation()}}v&&o.stopImmediatePropagation()}}}function w(o,e){var q,i,y,h,b,c,s,k=this,j=k.target,g=a(j),v=o.target,x=e&&e.path||o.path,l=a.view(j),r=l.ctx,u=r.beforeChange,p=m(j,v).paths[x],w=p&&p.length;while(w--){q=p[w];if((!u||!(e&&(y=u.call(this,o,e)===f)))&&(!l||l.onDataChanged(e)!==f)){b=q.attr;c=n(k,k.source,l,q.expr,e&&e.value);if(a.isFunction(c))c=c.call(v);if(!b){b=d.merge[j.nodeName.toLowerCase()];b=b?b.to.toAttr:"text"}if(s=b.indexOf("css-")===0&&b.substr(4))(h=g.css(s)!==c)&&g.css(s,c);else{i=t[b];if(i)(h=g[i]()!==c)&&g[i](c);else(h=g.attr(b)!==c)&&g.attr(b,c)}e&&h&&r.afterChange&&r.afterChange.call(k,o,e)}}}function x(g,a){var i,c=this.ctx,e=c.beforeChange,h=a?a.change:d.linkToAttr;if((!e||!(i=e.call(this,g,a)===f))&&h!==b){this.onDataChanged(a);c.afterChange&&c.afterChange.call(this,g,a)}}function j(d){var e,c=d.data,b=d._onArrayChange;if(b){if(b[1]===c)return;a([b[1]]).unbind("arrayChange",b[0])}if(a.isArray(c)){e=function(){x.apply(d,arguments)};a([c]).bind("arrayChange",e);d._onArrayChange=[e,c]}}function s(d,c,f){var b=d.parent&&d.parent.ctx,e=d._ctx;d.ctx=f?e&&b?a.extend({},b,e):b||e:c&&c!==b?(d._ctx=c,b?a.extend({},b,c):c):b}function i(h,k,g,m,d,l,b){var f,e,i,c=this;a.extend(c,{views:[],nodes:k?[]:[document.body],tmpl:m||d&&d.tmpl,path:g,parent:d,prevNode:k});if(d){f=d.views;l.push(c);b=b||d.data;if(a.isArray(d.data)){c.index=e=g;f.splice(e,0,c);i=f.length;b=b[e];while(e++<i-1)a.observable(f[e]).setProperty("index",e)}else{if(g){b=o(b,d,g);h=h||b[1];b=b[0]}c.index=f.length;f.push(c)}}c.data=b;s(c,h);j(c)}function g(f,s,r,y,m,o,x,t){var l,n,j,w,k,h=s,q=y;t=t||0;f=x||f;if(!x&&f.nodeType===1){q++===0&&h.nodes.push(f);var u=f.getAttribute(d.linkFromAttr),v=f.getAttribute(d.getFromAttr);(u||v)&&p(m||s.data,f,v,u,e);f=f.firstChild}else f=f.nextSibling;while(f&&f!==r){if(f.nodeType===1)g(f,h,r,q,m,o);else if(f.nodeType===8&&(l=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(f.nodeValue))){k=f.parentNode;if(l[1]){if(k!==h.prevNode.parentNode){l[2]&&k.parentNode.insertBefore(f.nextSibling,k.nextSibling);k.parentNode.insertBefore(f,k.nextSibling);return}h.nextNode=f;h.ctx.afterCreate&&h.ctx.afterCreate.call(h,h);if(l[2])h=s;else return f}else{n=n||c(k,"view",e);if(l[2])h=new i(o,f,t++,b,h,n);else{j=a.view(f);if(j&&j.prevNode===f)if(j.data===m)w=j.nextNode;else{j.data=m;j.render(o);return j.nextNode}else j=new i(o,f,l[3],l[4],h,n,m);f=w||g(f,j,r,0)}}}else q===0&&h.nodes.push(f);f=f.nextSibling}}function o(d,b,c){return Function("$","$data","$view","$ctx","with($data){ return ["+c+"];}")(a,d,b,b.ctx)}function n(d,e,b,c,f){try{return Function("$","$data","$view","$ctx","$value","with($data){return "+c+";}").call(d,a,e,b,b.ctx,f)}catch(g){throw g.message;}}function r(c,d,b){try{return b?Function("$","$data","$view","$ctx","with($data){return "+b+";}")(a,c,d,d.ctx):c}catch(e){throw e.message;}}function v(i,m,f,o){var d,l,n,h,k,j,e;if(f){f=a.isArray(f)?f:[f];h=[];k=[];e=f.length;while(e--){d=f[e];d.to&&h.push({to:d.to,filter:d.filter});(d.from||d.getFrom)&&k.push(d)}e=k.length;while(e--){d=k[e];l=d.filter;n=l?i.find(l).add(a(this).filter(l)):i;n.each(function(){p(m,this,d.getFrom,d.from)})}}(!f||h.length)&&i.each(function(){if(!f){j=c(this,"to");e=j.length;while(e--){d=j[e];if(d.links===declLinkTo){if(d.target===m)return;z(this,d.target,declLinkTo);j.splice(e,1)}}h=declLinkTo;i.each(function(){g(this,a.view(this),b,b,m,o)})}A(this,m,h)});return i}function p(p,x,u,m){var b,d,h,g,j,s,i,B,o,f,A,l=[],c="";m=k((m?m+",":"")+(u?"|,"+u+",":""),e);while(b=m.shift()){g=b.length;j=b.charAt(g-1);b=b.slice(0,-1);switch(j){case":":s=a.trim(b);break;case"[":c=a.trim(b);break;case")":c=c||b;break;case"]":l=[[c,b]];c=c?c+"."+b:b;c+=a.isFunction(p[b])?"()":"";break;case"\r":i=++b;break;case",":if(b==="|")B=e;else{if(i){f=c.slice(i);f=k(f);for(h=0,g=f.length;h<g;h++){d=a.trim(f[h]);j=d.charAt(d.length-1);d=d.slice(0,-1);if(j==="[")f[h]=o=d;else if(j==="]"){l.push([o,d]);f[h]=o?"."+d:d;f[h]+=a.isFunction(p[d])?"()":"";o=""}}c=c.slice(0,i)+f.join("")+")"}c+=b;A=a.view(x);g=l.length;while(g--){var v=l[g],z=v[1],w=r(p,A,v[0]),y={source:p,target:x},t=z.split("."),n=w;while(t.length>1){n=n[t.shift()];n&&q(n,y,t.join("."),c,s)}q(w,y,z,c,s,!g&&B)}i=0;l=[];s=c=""}}}}function q(f,l,g,o,n,p){var i,j,b,h=l.target,d=m(h,f),k={attr:n,expr:o};if(d){j=d.paths[g]=d.paths[g]||[];j.push(k);b=d.handler}else{b=function(){w.apply(l,arguments)};if(h){i={};i[g]=[k];c(h,"from",e).push({source:f,paths:i,handler:b})}a(f).bind("propertyChange",b)}p&&b({target:f,path:g})}function A(d,f,g){var b=function(){y.apply({target:f,links:g},arguments)};c(d,"to",e).push({target:f,links:g,handler:b});a(d).bind("change",b)}function z(e,g,h){var b,d=c(e,"to"),f=d.length;while(f--){b=d[f];b.target===g&&b.links===h&&a(e).unbind("change",b.handler)}}function m(e,d){var a,b=c(e,"from");l=b.length;while(l--){a=b[l];if(a.source===d)return a}}function D(j,d){var h,f,b,g,e,i;c(d,"to").length&&a(d).unbind("change");f=c(d,"from");b=f.length;while(b--){h=f[b];a(h.source).unbind("propertyChange",h.handler)}g=c(d,"view");if(b=g.length){e=a.view(d);while(b--){i=g[b];i.parent===e&&e.removeViews(i.index,1)}}}function c(c,e,d){var b=a.data(c,u)||d&&a.data(c,u,{view:[],from:[],to:[]});return b?b[e]:[]}function k(a,h){var c,d=0,b=0,g=f,e=f;a=a.replace(/\s+/g," ");return a.replace(/(\))|([\:\,])|(\')|(\")|([\(\[\{])|([\}\]])/g,function(f,o,n,j,k,m,l,i){if(e){e=!j;return f}if(g){g=!k;return f}if(o)return--b?f:h&&a.charAt(i+1)===","?(c-=d,d=i,f+"\t"+c+"\r\t"):f;if(n)return b?f:(d=i+1,f+"\t");if(m){if(b++)return f;if(f==="(")c=i;return f!=="["?f:"[\t"}if(l)return--b||f!=="]"?f:"]\t";e=j;g=k;return f}).split("\t")}function C(b){return b.type==="checkbox"?b.checked:a(b).val()}a.extend({view:function(b,o){var d,f,g,k,j,m=/^item|^tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/,l=document.body,n=b;if(o){j=b.nextSibling||b.parentNode;while(j!==(b=b.firstChild||b.nextSibling||b.parentNode.nextSibling))if(b.nodeType===8&&m.test(b.nodeValue)){f=a.view(b);if(f.prevNode===b)return f}return}b=b||l;if(h&&!h.views.length)d=h;else{while(!(g=c(j=b.parentNode||l,"view")).length){if(!j||b===l){c(l.parentNode,"view",e).push(d=h=new i);h.ctx={};break}b=j}if(!d&&b===l)d=g[0];while(!d&&b){if(b.nodeType===8)if(/^\/item|^\/tmpl$/.test(b.nodeValue)){k=g.length;while(k--){f=g[k];if(f.nextNode===b){d=b===n&&f;b=f.prevNode;break}}}else if(m.test(b.nodeValue)){k=g.length;while(k--){f=g[k];if(f.prevNode===b){d=f;break}}}b=b.previousSibling}d=d||a.view(j)}return d},linkSettings:{getProperty:function(c,b){return a.isFunction(b)?b.call(c):b},linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:C},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,f=a.change,c=a.index,d=a.items;switch(f){case"insert":b.addViews(c,d);break;case"remove":b.removeViews(c,d.length);break;case"move":b.render();break;case"refresh":b.render()}}return e},render:function(){var c=this.prevNode,e=this.nextNode,d=c.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(c).after(a.render(this.tmpl,this.data,this.ctx));d.removeChild(c.nextSibling);d.removeChild(e.previousSibling);g(d,this,e,0,b,b,c,0);j(this);return this},addViews:function(h,i,p){var f,l=i.length,k=this.ctx,m=this.views;if(l){if(this.path){f=this.parent;k=o(f.data,f,this.path)[1]}var n=a.render(p||this.tmpl,i,k,this,e),c=h?m[h-1].nextNode:this.prevNode,j=c.nextSibling,d=c.parentNode;a(c).after(n);d.removeChild(c.nextSibling);d.removeChild(j.previousSibling);g(d,this,j,0,b,b,c,h)}return this},removeViews:function(e,l,n){if(l){var g,k,m,i=this.views,o=e+l;while(o-->e){var d=i[o],f=d.views.length,h=d.prevNode,q=d.nextNode,p=[h];f&&d.removeViews(0,f,n);g=g||c(d.nextNode.parentNode,"view");f=g.length;while(f--&&k===b)if(g[f]===d)k=f;g.splice(k,1);if(!n){while(h!==q){h=h.nextSibling;p.push(h)}a(p).remove()}d.data=b;j(d)}i.splice(e,l);m=i.length;while(e<m)a.observable(i[e]).setProperty("index",e++)}return this},context:function(c){var a=this,d=a.parent,e=d?d.ctx:{};if(!c)a.each(function(a){a.ctx=e;a._ctx=b});else c!==a.ctx&&a.each(function(b){s(b,c,b!==a)});return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}},cleanData:function(b){a(b).each(D);B(b)}});a.fn.extend({view:function(b){return a.view(this[0],b)},addLinks:function(c,b,a){return v(this,c,b,a)},link:function(e,c,d){if(a.isPlainObject(c))d=c;else{c=a.template(c);if(c){this.empty();e&&this.append(a.render(c,e,d))}}return v(this,e,b,d)}});d=a.linkSettings;i.prototype=d.view;E=d.decl;declLinkTo=[{filter:"input["+d.linkToAttr+"]"}]})(jQuery);