/*
 * jQuery Views Plugin v1.0pre
 * Interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string).
 * See JsRender at http://github.com/BorisMoore/jsrender
 * and JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var c,f,n={value:"val",html:"html",text:"text"},i="data-jq-linkto",o="data-jq-linkfrom",u="data-jq-path",t={htmlhtml:1,arrayobject:1,objectarray:1};function d(A,u,o,j,G,F){function C(b,d,f){var e,h,c;if(typeof b==="object")for(e in b){c=b[e];b.hasOwnProperty(e)&&!a.isFunction(c)&&!(typeof c==="object"&&c.toJSON)&&C(c,(d?d+".":d)+e,f)}else f(b,d,g.convert,b)}function B(d,c,b,e){a.observable(k).setField(c,b?b(d,c,e,k,g):d)}var k,x=j&&(a.isFunction(j)?j:j.callback),t="view";if(o){t=h(o);k=o[0]}var v,D,y,H,J,m,I,g=typeof A==="string"?{to:g}:A&&a.extend({},A),q=g.from,s=u[0],r=h(u),w=r==="html",E=w?"change":r+"Change",z=function(q,l){var s,e,h,d=q.target,u={html:function(){var h,b,f;b=g.fromAttr;if(!b){b=c.merge[d.nodeName.toLowerCase()];b=b?b.from.fromAttr:"text"}h=n[b];f=a(d);e=h?f[h]():f.attr(b)},object:function(){var a=g.from||t!=="html"&&g.to;if(l){e=l.value;h=l.path;if(a&&h!==a)e=b}else{h=a||h;e=h&&p(d,h)||i}},array:function(){e=l?l.change:i}},v={html:function(){o.each(function(u,k){var o,r,s,i=e,j=a(k);function t(r,e,m,f,q){e=e||g.toAttr;m=m||q;f=window[f]||g.convert;s=!h||h===m;if(!l)i=p(d,m);if(i!==b&&s){if(f&&a.isFunction(f))i=f(i,d,h,k,g);if(!e){e=c.merge[k.nodeName.toLowerCase()];e=e?e.to.toAttr:"text"}if(css=e.indexOf("css-")===0&&e.substr(4))j.css(css)!==i&&j.css(css,i);else{o=n[e];if(o&&j[o]()!==i)j[o](i);else j.attr(e)!==i&&j.attr(e,i)}}}r=g.from;if(r)t("","",r);else{m=m||a.view(k);(!m||m.data===d&&m.onDataChanged(q.type,l)!==false)&&f.applyBindInfo(k,t)}})},view:function(){j.onDataChanged(q.type,l)},object:function(){var c=g.Convert,b=g.to||!w&&h;if(b)B(e,b,g.convert,d);else if(!w)C(d,"",B);else f.applyLinkInfo(d,function(i,f,h){var b=window[h]||c;m=a.view(d);a.observable(m.data).setField(f,b?b(e,f,d,m.data,g):e)})},array:function(){r==="array"}};u[r]();if(!x||!(s=x.call(g,q,l,o,g)===false))(k||x)&&t!=="none"&&e!==b&&v[t]();s&&q.stopImmediatePropagation()};switch(r+t){case"htmlarray":for(v=0,D=k.length;v<D;v++)d(g,u,a(k[v]),j);return;break;case"objecthtml":case"arrayhtml":if(g.link){g.link=false;e(g,G||k,0,j,F,s);return}o.each(function(b,a){l(a,"_jsvLinks").push([u,z])});break;case"objectview":return;case"arrayview":k=j;j.handler=z}u.bind(E,z);if(r==="object"&&q){q=q.split(".");if(q.length>1){s=s[q.shift()];if(s){y=a.extend({inner:1},g);y.from=q.join(".");d(y,a(s),o,j)}}}}function v(f,h,c,e,d,i){var a=g(f,h,b,c,e,i);a.index=d;a.data=c.data[d];return a}function j(k,c,i,e,h,d,l){var f=g(k,c,i,e,h,l);if(d===b&&c&&c!=="~"){var j=new Function("jQuery","$item","var $=jQuery,$data=$item.data; with($data){ return "+c+"}");d=j(a,e)}f.data=d;return f}function g(f,h,e,b,d,i){if(!this.refresh)return new g(f,h,e,b,d,i);var c=this;a.extend(c,{views:[],nodes:[],bindings:[],tmpl:e||b&&b.tmpl,path:h,parent:b,prevNode:f,map:i});if(b){a:b.callback,d.push(c);b.views.push(c)}}function l(c,b){b=b||"_jsView";return a.data(c,b)||a.data(c,b,[])}function e(h,c,s,q,r,t,k){var g,u,n,f=q,i=s;k=k||0;function p(c){if(c.data){c.bindings.length&&d(h,a([c.data]),a(c.bindings),c);d(h,a([c.data]),b,c)}}function m(){return n||(n=l(c.parentNode))}if(c.nodeType===1){i++===0&&f.nodes.push(c);c.getAttribute(o)&&f.bindings.push(c);c=c.firstChild}else c=c.nextSibling;while(c!=r){if(c.nodeType===1)e(h,c,i,f);else if(c.nodeType===8&&(g=/^(\/?)(?:(item)|(?:tmpl(?:\((.+)\))?(?:\s+([^\s]+))?))$/.exec(c.nodeValue)))if(g[1])if(g[2]){f.nextNode=c;p(f);f=q}else{f.nextNode=c;p(f);return c}else if(g[2])f=v(c,"*",f,m(),k++,h);else c=e(h,c,0,j(c,g[3],g[4],f,m(),t,h));else i===0&&f.nodes.push(c);c=c.nextSibling}}function h(b){b=b[0];return b?b.nodeType?"html":a.isArray(b)?"array":"object":"none"}function m(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function p(a,c){if(a&&c){var b=k(a,c);a=b[0];if(a)return a[b[1]]}}function k(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()];return[a,b]}return[]}function q(f){var b,g,c=f&&a.data(f,"_jsvLinks");if(c)for(b=0,g=c.length;b<g;b++){var e=c[b],d=e[0];d.unbind((a.isArray(d[0])?"array":"object")+"Change",e[1])}}var s=a.cleanData;a.extend({cleanData:function(a){for(var c=0,b;(b=a[c])!=null;c++)q(b);s(a)},dataLink:function(l,f,g,v,o){var k=a.makeArray(arguments),w=k.length-1;if(!o&&a.isFunction(k[w])){k[4]=k.pop();return a.dataLink.apply(a,k)}l=m(l);f=m(f);var q,n,c,e,r=f,s=h(l),p=h(f),u=f[0];if(p==="html"){e=a.data(u,"_jsTopView");e&&e.unlink();e=j();e.callback=o;a.data(u,"_jsTopView",e);if(g&&!g.nodeType){c=g;g=b}}c=c||!t[s+p]&&{link:true};if(s==="html"&&c.link)c.from="input["+i+"]";c=a.isArray(c)?c:[c];q=c.length;while(q--){n=c[q];if(p==="html"){path=n.to;if(path){r=f.find(path).add(f.filter(path));n.to=b}r.each(function(){d(n,l,a(this),e,g,v)})}else d(n,l,f,o)}return e},view:function(b){var d,c,e;while(b){if(b.nodeType===8&&/^item|tmpl(\([\w\.\~]+\))?(\s+[^\s]+)?$/.test(b.nodeValue)){c=a.data(b.parentNode,"_jsView");e=c&&c.length;while(e--){d=c[e];if(d.prevNode===b)return d}return}b=b.previousSibling||b.parentNode}},dataLinkSettings:{decl:{linkAttr:i,bindAttr:o,pathAttr:u,applyLinkInfo:function(c,b){var a=c.getAttribute(f.linkAttr);a!==null&&a.replace(/([\w\.]*)(?:\:\s*(\w+)\(\)\s*)?$/,b)},applyBindInfo:function(b,c){var a=b.nodeType===1&&b.getAttribute(f.bindAttr);a&&a.replace(/(?:([\w\-]+)\:\s*)?(?:(?:([\w\.]+)|(\w+)\(\s*([\w\.]+)\s*\))(?:$|,))/g,c)}},merge:{input:{from:{fromAttr:"value"},to:{toAttr:"value"}}},view:{pushValues:function(){var a,c=0,b=links.length;while(b--){a=links[b];!a.map.inner&&a.from.each(function(){a.handler({type:a.type,target:this})})}return this},onDataChanged:function(h,a){var b=this,g=a.change,c=a.newIndex,e=a.oldIndex,d=a.newItems,f=a.oldItems;switch(g){case"add":b.addItems(c,d);break;case"remove":b.removeItems(e,f.length);break;case"move":b.refresh();break;case"reset":b.refresh()}return true},refresh:function(){var f=a.render(this.tmpl,this.data),b=this.prevNode,d=this.nextNode,c=b.parentNode;this.map={link:true};a(this.nodes).remove();this.removeItems(0,this.views.length);this.nodes=[];a(b).after(f);this.prevNode=b.nextSibling;c.removeChild(b);c.removeChild(d.previousSibling);e(this.map,this.prevNode,0,this,this.nextNode,this.data,this.index)},addItems:function(c,f,k){var h=f.length,i=this.views;if(h){var j=a.render(k||this.tmpl,f),b=c?i[c-1].nextNode:this.prevNode,g=b.nextSibling,d=b.parentNode;a(b).after(j);d.removeChild(b.nextSibling);d.removeChild(g.previousSibling);e(this.map,b||this.prevNode,0,this,g,this.data,c)}},removeItems:function(b,d){if(d){var e=this.views,f=b+d;while(f-->b){var h=e[f],c=h.prevNode,i=h.nextNode,g=[c];while(c!==i){c=c.nextSibling;g.push(c)}a(g).remove()}e.splice(b,d);viewCount=e.length;while(b<viewCount)e[b++].index-=d}},unlink:function(){var b,d,e,c=this.views;this.handler&&a([this.data]).unbind("arrayChange",this.handler);for(b=0,d=c.length;b<d;b++)c[b].unlink()}}}});a.fn.extend({dataLink:function(e,d,c,b){a.dataLink(this,e,d,c,b);a.dataLink(e,this,d,c,b);return this},view:function(){return a.view(this[0])}});c=a.dataLinkSettings;j.prototype=c.view;g.prototype=c.view;f=c.decl})(jQuery);