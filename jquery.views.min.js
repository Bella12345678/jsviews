/*
 * jQuery Data Link plugin 1.0.0pre
 *
 * BETA2 INVESTIGATION
 *
 * http://github.com/jquery/jquery-datalink
 *
 * Copyright Software Freedom Conservancy, Inc.
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 */
(function(a,b){var c,e,p={value:"val",html:"html",text:"text"},i="data-jq-linkto",q="data-jq-linkfrom",v="data-jq-path",u={htmlhtml:1,arrayobject:1,objectarray:1};getEventArgs={pop:function(a){if(a.length)return{change:"remove",oldIndex:a.length-1,oldItems:[a[a.length-1]]}},push:function(b,a){return{change:"add",newIndex:b.length,newItems:[a[0]]}},reverse:function(a){if(a.length)return{change:"reset"}},shift:function(a){if(a.length)return{change:"remove",oldIndex:0,oldItems:[a[0]]}},sort:function(a){if(a.length)return{change:"reset"}},splice:function(f,d){var a=d[0],e=d[1],c,b=d.slice(2);if(e<=0){if(b.length)return{change:"add",newIndex:a,newItems:b}}else{c=f.slice(a,a+e);return b.length?{change:"move",oldIndex:a,oldItems:c,newIndex:a,newItems:b}:{change:"remove",oldIndex:a,oldItems:c}}},unshift:function(b,a){return{change:"add",newIndex:0,newItems:[a[0]]}},move:function(c){var a,b=arguments[1];if(b>0){a=arguments[0];return{change:"move",oldIndex:a,oldItems:c.splice(a,b),newIndex:arguments[2]}}}};function m(c,b){if(b){var d=a([c]);switch(b.change){case"add":c.push(b.newItems[0]);break;case"remove":c.splice(b.oldIndex,b.oldItems.length);break;case"move":c.splice(b.newIndex,0,c.splice(b.oldIndex,b.number))}d.triggerHandler("arrayChange!",b)}}function d(B,v,q,l,H,G){function D(b,d,g){var e,h,c;if(typeof b==="object")for(e in b){c=b[e];b.hasOwnProperty(e)&&!a.isFunction(c)&&!(typeof c==="object"&&c.toJSON)&&D(c,(d?d+".":d)+e,g)}else g(b,d,f.convert,b)}function C(d,c,b,e){a.setField(k,c,b?b(d,c,e,k,f):d)}var k,y=l&&(a.isFunction(l)?l:l.callback),u="view";if(q){u=g(q);k=q[0]}var w,E,z,I,K,o,J,f=typeof B==="string"?{to:f}:B&&a.extend({},B),r=f.from,t=v[0],s=g(v),x=s==="html",F=x?"change":s+"Change",A=function(r,d){var v,h,n,g=r.target,w={html:function(){var e,b,d;b=f.fromAttr;if(!b){b=c.merge[g.nodeName.toLowerCase()];b=b?b.from.fromAttr:"text"}e=p[b];d=a(g);h=e?d[e]():d.attr(b)},object:function(){var a=f.from||u!=="html"&&f.to;if(d){h=d.value;n=d.path;if(a&&n!==a)h=b}else{n=a||n;h=n&&j(g,n)||i}},array:function(){h=d?d.change:i}},z={html:function(){q.each(function(u,l){var m,q,s,i=h,k=a(l);function t(r,e,o,h,q){e=e||f.toAttr;o=o||q;h=window[h]||f.convert;s=!n||n===o;if(!d)i=j(g,o);if(i!==b&&s){if(h&&a.isFunction(h))i=h(i,g,n,l,f);if(!e){e=c.merge[l.nodeName.toLowerCase()];e=e?e.to.toAttr:"text"}if(css=e.indexOf("css-")===0&&e.substr(4))k.css(css)!==i&&k.css(css,i);else{m=p[e];if(m&&k[m]()!==i)k[m](i);else k.attr(e)!==i&&k.attr(e,i)}}}q=f.from;if(q)t("","",q);else{o=o||a.view(l);(!o||o.data===g&&o.onDataChanged(r.type,d)!==false)&&e.applyBindInfo(l,t)}})},view:function(){l.onDataChanged(r.type,d)},object:function(){var c=f.Convert,b=f.to||!x&&n;if(b)C(h,b,f.convert,g);else if(!x)D(g,"",C);else e.applyLinkInfo(g,function(i,d,e){var b=window[e]||c;o=a.view(g);a.setField(o.data,d,b?b(h,d,g,o.data,f):h)})},array:function(){if(s==="array"){if(!d){var b=a.map(t,function(b){return a.extend(true,{},b)});b.unshift(k.length);b.unshift(0);d=getEventArgs.splice(k,b)}m(k,d)}}};w[s]();if(!y||!(v=y.call(f,r,d,q,f)===false))(k||y)&&u!=="none"&&h!==b&&z[u]();v&&r.stopImmediatePropagation()};switch(s+u){case"htmlarray":for(w=0,E=k.length;w<E;w++)d(f,v,a(k[w]),l);return;break;case"objecthtml":case"arrayhtml":if(f.link){f.link=false;h(f,H||k,0,l,G,t);return}q.each(function(b,a){n(a,"_jsvLinks").push([v,A])});break;case"objectview":return;case"arrayview":k=l;l.handler=A}v.bind(F,A);if(s==="object"&&r){r=r.split(".");if(r.length>1){t=t[r.shift()];if(t){z=a.extend({inner:1},f);z.from=r.join(".");d(z,a(t),q,l)}}}}function s(a,c){if(a&&c){var b=c.split(".");while(a&&b.length)a=a[b.shift()];return a}}function w(g,h,c,e,d,i){var a=f(g,h,b,c,e,i);a.index=d;a.data=c.data[d];return a}function k(h,c,g,a,e,b,i){var d=f(h,c,g,a,e,b,i);d.data=b||s(a&&a.data,c);return d}function f(g,h,e,b,d,j,i){if(!this.refresh)return new f(g,h,e,b,d,j,i);var c=this;a.extend(c,{views:[],nodes:[],bindings:[],tmpl:e||b&&b.tmpl,path:h,parent:b,prevNode:g,map:i});if(b){a:b.callback,d.push(c);b.views.push(c)}}function n(c,b){b=b||"_jsView";return a.data(c,b)||a.data(c,b,[])}function h(g,c,s,p,r,t,j){var f,u,m,e=p,i=s;j=j||0;function o(c){c.bindings.length&&d(g,a([c.data]),a(c.bindings),c);d(g,a([c.data]),b,c)}function l(){return m||(m=n(c.parentNode))}if(c.nodeType===1){i++===0&&e.nodes.push(c);c.getAttribute(q)&&e.bindings.push(c);c=c.firstChild}else c=c.nextSibling;while(c!=r){if(c.nodeType===1)h(g,c,i,e);else if(c.nodeType===8&&(f=/^(\/?)(?:(item)|(?:tmpl(?:\(([\w\.\~]+)\))?(?:\s+([^\s]+))?))$/.exec(c.nodeValue)))if(f[1])if(f[2]){e.nextNode=c;o(e);e=p}else{e.nextNode=c;o(e);return c}else if(f[2])e=w(c,"*",e,l(),j++,g);else c=h(g,c,0,k(c,f[3],f[4],e,l(),t,g));else i===0&&e.nodes.push(c);c=c.nextSibling}}function g(b){b=b[0];return b?b.nodeType?"html":a.isArray(b)?"array":"object":"none"}function o(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function j(a,c){if(a&&c){var b=l(a,c);a=b[0];if(a)return a[b[1]]}}function l(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()];return[a,b]}return[]}function r(f){var b,g,c=f&&a.data(f,"_jsvLinks");if(c)for(b=0,g=c.length;b<g;b++){var e=c[b],d=e[0];d.unbind((a.isArray(d[0])?"array":"object")+"Change",e[1])}}var t=a.cleanData;a.extend({cleanData:function(a){for(var c=0,b;(b=a[c])!=null;c++)r(b);t(a)},dataLink:function(l,f,h,v,n){var j=a.makeArray(arguments),w=j.length-1;if(!n&&a.isFunction(j[w])){j[4]=j.pop();return a.dataLink.apply(a,j)}l=o(l);f=o(f);var q,m,c,e,r=f,s=g(l),p=g(f),t=f[0];if(p==="html"){e=a.data(t,"_jsTopView");e&&e.unlink();e=k();e.callback=n;a.data(t,"_jsTopView",e);if(h&&!h.nodeType){c=h;h=b}}c=c||!u[s+p]&&{link:true};if(s==="html"&&c.link)c.from="input["+i+"]";c=a.isArray(c)?c:[c];q=c.length;while(q--){m=c[q];if(p==="html"){path=m.to;if(path){r=f.find(path).add(f.filter(path));m.to=b}r.each(function(){d(m,l,a(this),e,h,v)})}else d(m,l,f,n)}return e},setField:function(b,c,d){if(c){var f=a(b),g=[{path:c,value:d}],e=l(b,c);b=e[0],c=e[1];if(b&&b[c]!==d){b[c]=d;f.triggerHandler("objectChange!",g)}}},getField:function(a,b){return j(a,b)},view:function(b){var d,c,e;while(b){if(b.nodeType===8&&/^item|tmpl(\([\w\.\~]+\))?(\s+[^\s]+)?$/.test(b.nodeValue)){c=a.data(b.parentNode,"_jsView");e=c&&c.length;while(e--){d=c[e];if(d.prevNode===b)return d}return}b=b.previousSibling||b.parentNode}},changeArray:function(b,d){var c=a.makeArray(arguments);c.splice(0,2);return m(b,getEventArgs[d](b,c))},dataLinkSettings:{decl:{linkAttr:i,bindAttr:q,pathAttr:v,applyLinkInfo:function(c,b){var a=c.getAttribute(e.linkAttr);a!==null&&a.replace(/([\w\.]*)(?:\:\s*(\w+)\(\)\s*)?$/,b)},applyBindInfo:function(b,c){var a=b.nodeType===1&&b.getAttribute(e.bindAttr);a&&a.replace(/(?:([\w\-]+)\:\s*)?(?:(?:([\w\.]+)|(\w+)\(\s*([\w\.]+)\s*\))(?:$|,))/g,c)}},merge:{input:{from:{fromAttr:"value"},to:{toAttr:"value"}}},view:{pushValues:function(){var a,c=0,b=links.length;while(b--){a=links[b];!a.map.inner&&a.from.each(function(){a.handler({type:a.type,target:this})})}return this},onDataChanged:function(h,a){var b=this,g=a.change,c=a.newIndex,e=a.oldIndex,d=a.newItems,f=a.oldItems;switch(g){case"add":b.add(c,d);break;case"remove":b.remove(e,f.length)}return true},refresh:function(){this.parent.add(this.index,[this.data]);this.parent.remove(this.index,1)},add:function(c,e){var g=e.length,i=this.views;if(g){var j=a.render(this.tmpl,e,{annotate:true}),b=c?i[c-1].nextNode:this.prevNode,f=b.nextSibling,d=b.parentNode;a(b).after(j);d.removeChild(b.nextSibling);d.removeChild(f.previousSibling);h(this.map,b||this.prevNode,0,this,f,this.data,c)}},remove:function(b,e){var c=this.views;if(e){var d=c[b].prevNode,g=c[b+e-1].nextNode,f=[d];while(d!==g){d=d.nextSibling;f.push(d)}a(f).remove()}c.splice(b,e);viewCount=c.length;while(b<viewCount)c[b++].index-=e},unlink:function(){var b,d,e,c=this.views;this.handler&&a([this.data]).unbind("arrayChange",this.handler);for(b=0,d=c.length;b<d;b++)c[b].unlink()}}}});a.fn.extend({dataLink:function(e,d,c,b){a.dataLink(this,e,d,c,b);a.dataLink(e,this,d,c,b);return this},view:function(){return a.view(this[0])}});c=a.dataLinkSettings;k.prototype=c.view;f.prototype=c.view;e=c.decl})(jQuery)