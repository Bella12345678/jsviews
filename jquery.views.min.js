/*
 * jQuery Views Plugin v1.0pre
 * Interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link. 
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string). 
 * See JsRender at http://github.com/BorisMoore/jsrender
 * and JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var c,f,p={value:"val",html:"html",text:"text"},i="data-jq-linkto",q="data-jq-linkfrom",v="data-jq-path",u={htmlhtml:1,arrayobject:1,objectarray:1};getEventArgs={pop:function(a){if(a.length)return{change:"remove",oldIndex:a.length-1,oldItems:[a[a.length-1]]}},push:function(b,a){return{change:"add",newIndex:b.length,newItems:[a[0]]}},reverse:function(a){if(a.length)return{change:"reset"}},shift:function(a){if(a.length)return{change:"remove",oldIndex:0,oldItems:[a[0]]}},sort:function(a){if(a.length)return{change:"reset"}},splice:function(f,d){var a=d[0],e=d[1],c,b=d.slice(2);if(e<=0){if(b.length)return{change:"add",newIndex:a,newItems:b}}else{c=f.slice(a,a+e);return b.length?{change:"move",oldIndex:a,oldItems:c,newIndex:a,newItems:b}:{change:"remove",oldIndex:a,oldItems:c}}},unshift:function(b,a){return{change:"add",newIndex:0,newItems:[a[0]]}},move:function(c){var a,b=arguments[1];if(b>0){a=arguments[0];return{change:"move",oldIndex:a,oldItems:c.splice(a,b),newIndex:arguments[2]}}}};function m(c,b){if(b){var d=a([c]);switch(b.change){case"add":c.push(b.newItems[0]);break;case"remove":c.splice(b.oldIndex,b.oldItems.length);break;case"move":c.splice(b.newIndex,0,c.splice(b.oldIndex,b.number))}d.triggerHandler("arrayChange!",b)}}function d(B,v,q,l,H,G){function D(b,d,f){var e,h,c;if(typeof b==="object")for(e in b){c=b[e];b.hasOwnProperty(e)&&!a.isFunction(c)&&!(typeof c==="object"&&c.toJSON)&&D(c,(d?d+".":d)+e,f)}else f(b,d,g.convert,b)}function C(d,c,b,e){a.setField(j,c,b?b(d,c,e,j,g):d)}var j,y=l&&(a.isFunction(l)?l:l.callback),u="view";if(q){u=h(q);j=q[0]}var w,E,z,I,K,o,J,g=typeof B==="string"?{to:g}:B&&a.extend({},B),r=g.from,t=v[0],s=h(v),x=s==="html",F=x?"change":s+"Change",A=function(r,d){var v,h,n,e=r.target,w={html:function(){var f,b,d;b=g.fromAttr;if(!b){b=c.merge[e.nodeName.toLowerCase()];b=b?b.from.fromAttr:"text"}f=p[b];d=a(e);h=f?d[f]():d.attr(b)},object:function(){var a=g.from||u!=="html"&&g.to;if(d){h=d.value;n=d.path;if(a&&n!==a)h=b}else{n=a||n;h=n&&k(e,n)||i}},array:function(){h=d?d.change:i}},z={html:function(){q.each(function(u,l){var m,q,s,i=h,j=a(l);function t(r,f,o,h,q){f=f||g.toAttr;o=o||q;h=window[h]||g.convert;s=!n||n===o;if(!d)i=k(e,o);if(i!==b&&s){if(h&&a.isFunction(h))i=h(i,e,n,l,g);if(!f){f=c.merge[l.nodeName.toLowerCase()];f=f?f.to.toAttr:"text"}if(css=f.indexOf("css-")===0&&f.substr(4))j.css(css)!==i&&j.css(css,i);else{m=p[f];if(m&&j[m]()!==i)j[m](i);else j.attr(f)!==i&&j.attr(f,i)}}}q=g.from;if(q)t("","",q);else{o=o||a.view(l);(!o||o.data===e&&o.onDataChanged(r.type,d)!==false)&&f.applyBindInfo(l,t)}})},view:function(){l.onDataChanged(r.type,d)},object:function(){var c=g.Convert,b=g.to||!x&&n;if(b)C(h,b,g.convert,e);else if(!x)D(e,"",C);else f.applyLinkInfo(e,function(i,d,f){var b=window[f]||c;o=a.view(e);a.setField(o.data,d,b?b(h,d,e,o.data,g):h)})},array:function(){if(s==="array"){if(!d){var b=a.map(t,function(b){return a.extend(true,{},b)});b.unshift(j.length);b.unshift(0);d=getEventArgs.splice(j,b)}m(j,d)}}};w[s]();if(!y||!(v=y.call(g,r,d,q,g)===false))(j||y)&&u!=="none"&&h!==b&&z[u]();v&&r.stopImmediatePropagation()};switch(s+u){case"htmlarray":for(w=0,E=j.length;w<E;w++)d(g,v,a(j[w]),l);return;break;case"objecthtml":case"arrayhtml":if(g.link){g.link=false;e(g,H||j,0,l,G,t);return}q.each(function(b,a){n(a,"_jsvLinks").push([v,A])});break;case"objectview":return;case"arrayview":j=l;l.handler=A}v.bind(F,A);if(s==="object"&&r){r=r.split(".");if(r.length>1){t=t[r.shift()];if(t){z=a.extend({inner:1},g);z.from=r.join(".");d(z,a(t),q,l)}}}}function w(f,h,c,e,d,i){var a=g(f,h,b,c,e,i);a.index=d;a.data=c.data[d];return a}function l(k,c,i,e,h,d,l){var f=g(k,c,i,e,h,l);if(d===b&&c&&c!=="~"){var j=new Function("jQuery","$item","var $=jQuery,$data=$item.data; with($data){ return "+c+"}");d=j(a,e)}f.data=d;return f}function g(f,h,e,b,d,i){if(!this.refresh)return new g(f,h,e,b,d,i);var c=this;a.extend(c,{views:[],nodes:[],bindings:[],tmpl:e||b&&b.tmpl,path:h,parent:b,prevNode:f,map:i});if(b){a:b.callback,d.push(c);b.views.push(c)}}function n(c,b){b=b||"_jsView";return a.data(c,b)||a.data(c,b,[])}function e(h,c,s,p,r,t,j){var g,u,m,f=p,i=s;j=j||0;function o(c){if(c.data){c.bindings.length&&d(h,a([c.data]),a(c.bindings),c);d(h,a([c.data]),b,c)}}function k(){return m||(m=n(c.parentNode))}if(c.nodeType===1){i++===0&&f.nodes.push(c);c.getAttribute(q)&&f.bindings.push(c);c=c.firstChild}else c=c.nextSibling;while(c!=r){if(c.nodeType===1)e(h,c,i,f);else if(c.nodeType===8&&(g=/^(\/?)(?:(item)|(?:tmpl(?:\((.+)\))?(?:\s+([^\s]+))?))$/.exec(c.nodeValue)))if(g[1])if(g[2]){f.nextNode=c;o(f);f=p}else{f.nextNode=c;o(f);return c}else if(g[2])f=w(c,"*",f,k(),j++,h);else c=e(h,c,0,l(c,g[3],g[4],f,k(),t,h));else i===0&&f.nodes.push(c);c=c.nextSibling}}function h(b){b=b[0];return b?b.nodeType?"html":a.isArray(b)?"array":"object":"none"}function o(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function k(a,c){if(a&&c){var b=j(a,c);a=b[0];if(a)return a[b[1]]}}function j(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()];return[a,b]}return[]}function r(f){var b,g,c=f&&a.data(f,"_jsvLinks");if(c)for(b=0,g=c.length;b<g;b++){var e=c[b],d=e[0];d.unbind((a.isArray(d[0])?"array":"object")+"Change",e[1])}}var t=a.cleanData;a.extend({cleanData:function(a){for(var c=0,b;(b=a[c])!=null;c++)r(b);t(a)},dataLink:function(k,f,g,v,n){var j=a.makeArray(arguments),w=j.length-1;if(!n&&a.isFunction(j[w])){j[4]=j.pop();return a.dataLink.apply(a,j)}k=o(k);f=o(f);var q,m,c,e,r=f,s=h(k),p=h(f),t=f[0];if(p==="html"){e=a.data(t,"_jsTopView");e&&e.unlink();e=l();e.callback=n;a.data(t,"_jsTopView",e);if(g&&!g.nodeType){c=g;g=b}}c=c||!u[s+p]&&{link:true};if(s==="html"&&c.link)c.from="input["+i+"]";c=a.isArray(c)?c:[c];q=c.length;while(q--){m=c[q];if(p==="html"){path=m.to;if(path){r=f.find(path).add(f.filter(path));m.to=b}r.each(function(){d(m,k,a(this),e,g,v)})}else d(m,k,f,n)}return e},setField:function(b,c,d){if(c){var f=a(b),g=[{path:c,value:d}],e=j(b,c);b=e[0],c=e[1];if(b&&b[c]!==d){b[c]=d;f.triggerHandler("objectChange!",g)}}},getField:function(a,b){return k(a,b)},view:function(b){var d,c,e;while(b){if(b.nodeType===8&&/^item|tmpl(\([\w\.\~]+\))?(\s+[^\s]+)?$/.test(b.nodeValue)){c=a.data(b.parentNode,"_jsView");e=c&&c.length;while(e--){d=c[e];if(d.prevNode===b)return d}return}b=b.previousSibling||b.parentNode}},changeArray:function(b,d){var c=a.makeArray(arguments);c.splice(0,2);return m(b,getEventArgs[d](b,c))},dataLinkSettings:{decl:{linkAttr:i,bindAttr:q,pathAttr:v,applyLinkInfo:function(c,b){var a=c.getAttribute(f.linkAttr);a!==null&&a.replace(/([\w\.]*)(?:\:\s*(\w+)\(\)\s*)?$/,b)},applyBindInfo:function(b,c){var a=b.nodeType===1&&b.getAttribute(f.bindAttr);a&&a.replace(/(?:([\w\-]+)\:\s*)?(?:(?:([\w\.]+)|(\w+)\(\s*([\w\.]+)\s*\))(?:$|,))/g,c)}},merge:{input:{from:{fromAttr:"value"},to:{toAttr:"value"}}},view:{pushValues:function(){var a,c=0,b=links.length;while(b--){a=links[b];!a.map.inner&&a.from.each(function(){a.handler({type:a.type,target:this})})}return this},onDataChanged:function(h,a){var b=this,g=a.change,c=a.newIndex,e=a.oldIndex,d=a.newItems,f=a.oldItems;switch(g){case"add":b.addItems(c,d);break;case"remove":b.removeItems(e,f.length)}return true},refresh:function(){var f=a.render(this.tmpl,this.data,{annotate:true}),b=this.prevNode,d=this.nextNode,c=b.parentNode;this.map={link:true};a(this.nodes).remove();this.removeItems(0,this.views.length);this.nodes=[];a(b).after(f);this.prevNode=b.nextSibling;c.removeChild(b);c.removeChild(d.previousSibling);e(this.map,this.prevNode,0,this,this.nextNode,this.data,this.index)},addItems:function(c,f,k){var h=f.length,i=this.views;if(h){var j=a.render(k||this.tmpl,f,{annotate:true}),b=c?i[c-1].nextNode:this.prevNode,g=b.nextSibling,d=b.parentNode;a(b).after(j);d.removeChild(b.nextSibling);d.removeChild(g.previousSibling);e(this.map,b||this.prevNode,0,this,g,this.data,c)}},removeItems:function(b,d){if(d){var e=this.views,f=b+d;while(f-->b){var h=e[f],c=h.prevNode,i=h.nextNode,g=[c];while(c!==i){c=c.nextSibling;g.push(c)}a(g).remove()}e.splice(b,d);viewCount=e.length;while(b<viewCount)e[b++].index-=d}},unlink:function(){var b,d,e,c=this.views;this.handler&&a([this.data]).unbind("arrayChange",this.handler);for(b=0,d=c.length;b<d;b++)c[b].unlink()}}}});a.fn.extend({dataLink:function(e,d,c,b){a.dataLink(this,e,d,c,b);a.dataLink(e,this,d,c,b);return this},view:function(){return a.view(this[0])}});c=a.dataLinkSettings;l.prototype=c.view;g.prototype=c.view;f=c.decl})(jQuery);