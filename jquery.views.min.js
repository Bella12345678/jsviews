/*
 * JsViews v1.0pre
 * jQuery plugin providing interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string)
 *    See JsRender at http://github.com/BorisMoore/jsrender
 * and jquery.observable.js.
 *    See JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,c){var f=false,e=true,h,d,F,t={value:"val",html:"html",text:"text"},u="_jsvData";function y(n){var v,u,b,w,e,j,g,k,l,A,i,p=this.target,h=n.target,q=a(h),y=this.links,r=this.options||{},x=r.beforeChange,z=y.length;while(z--&&!u){g=y[z];if(!g.filter||g.filter&&q.is(g.filter)){b=g.fromAttr;if(!b){b=d.merge[h.nodeName.toLowerCase()];b=b?b.from.fromAttr:"text"}v=t[b];j=a.isFunction(b)?b(h):v?q[v]():q.attr(b);if((!x||!(u=x(n)===f))&&j!==c){e=g.to||a.trim(h.getAttribute(d.linkToAttr));if(e){k=g.convert;e=m(e);i=e[0].slice(0,-1);l=a.view(h);p=l&&l.data||p;i=s(p,l,i);w=a.trim(e[1].slice(0,-1));k=e[3];if(k)j=o({source:h,target:i,convert:k,path:w},p,l,k,j);if(i){a.observable(i).setProperty(w,j);r.afterChange&&r.afterChange(n)}n.stopPropagation()}}u&&n.stopImmediatePropagation()}}}function w(k,c){var m,i,v,h,b,g=this,j=g.target,e=a(j),s=k.target,u=c&&c.path||k.path,p=g.options||{},r=p.beforeChange,q=a.view(j);pathInfos=n(j,s).paths[u],l=pathInfos&&pathInfos.length;while(l--){m=pathInfos[l];if((!r||!(c&&(v=r.call(this,k,c)===f)))&&(!q||q.onDataChanged(c)!==f)){b=m.attr;sourceValue=o(g,g.source,q,m.expr,c&&c.value);if(a.isFunction(sourceValue))sourceValue=sourceValue.call(s);if(!b){b=d.merge[j.nodeName.toLowerCase()];b=b?b.to.toAttr:"text"}if(css=b.indexOf("css-")===0&&b.substr(4))(h=e.css(css)!==sourceValue)&&e.css(css,sourceValue);else{i=t[b];if(i)(h=e[i]()!==sourceValue)&&e[i](sourceValue);else(h=e.attr(b)!==sourceValue)&&e.attr(b,sourceValue)}c&&h&&p.afterChange&&p.afterChange.call(g,k,c)}}}function x(g,a){var i,b=this.options||{},e=b.beforeChange,h=a?a.change:d.linkToAttr;if((!e||!(i=e(g,a)===f))&&h!==c){this.onDataChanged(a);b.afterChange&&b.afterChange(g,a)}}function k(d){var e,c=d.data,b=d._onArrayChange;if(b){if(b[1]===c)return;a([b[1]]).unbind("arrayChange",b[0])}if(a.isArray(c)){e=function(){x.apply(d,arguments)};a([c]).bind("arrayChange",e);d._onArrayChange=[e,c]}}function j(l,h,g,j,c,i,b){var f,e,d=this;a.extend(d,{options:l,views:[],nodes:h?[]:[document.body],tmpl:j||c&&c.tmpl,path:g,parent:c,prevNode:h});if(c){f=c.views;i.push(d);b=b||c.data;if(a.isArray(c.data)){d.index=e=g;f.splice(e,0,d);viewCount=f.length;b=b[e];while(e++<viewCount-1)a.observable(f[e]).setProperty("index",e)}else{if(g){b=p(b,c,g);b[1];b=b[0]}d.index=f.length;f.push(d)}}d.data=b;k(d)}function g(f,s,k,r,y,n,x,t){var m,z,o,B,A,i,w,l,h=s,p=y;k=k||parentOptions;t=t||0;f=x||f;if(!x&&f.nodeType===1){p++===0&&h.nodes.push(f);var u=f.getAttribute(d.linkFromAttr),v=f.getAttribute(d.getFromAttr);(u||v)&&q(n||s.data,f,v,u,k,e);f=f.firstChild}else f=f.nextSibling;while(f&&f!==r){if(f.nodeType===1)g(f,h,k,r,p,n);else if(f.nodeType===8&&(m=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(f.nodeValue))){l=f.parentNode;if(m[1]){if(l!==h.prevNode.parentNode){m[2]&&l.parentNode.insertBefore(f.nextSibling,l.nextSibling);l.parentNode.insertBefore(f,l.nextSibling);return}if(m[2]){h.nextNode=f;h.onCreated(h);h=s}else{h.nextNode=f;h.onCreated(h);return f}}else{o=o||b(l,"view",e);if(m[2])h=new j(k,f,t++,c,h,o);else{i=a.view(f);if(i&&i.prevNode===f)if(i.data===n)w=i.nextNode;else{i.data=n;i.render(k);return i.nextNode}else i=new j(k,f,m[3],m[4],h,o,n);f=w||g(f,i,k,r,0)}}}else p===0&&h.nodes.push(f);f=f.nextSibling}}function p(d,b,c){return Function("$","$data","$view","$options","with($data){ return ["+c+"];}")(a,d,b,b.options)}function o(d,e,b,c,f){try{return Function("$","$data","$view","$options","$value","with($data){return "+c+";}").call(d,a,e,b,b.options,f)}catch(g){throw g.message;}}function s(c,d,b){try{return b?Function("$","$data","$view","$options","with($data){return "+b+";}")(a,c,d,d.options):c}catch(e){throw e.message;}}function v(h,l,e,f){f=a.isFunction(f)?{beforeChange:f}:f||{};if(e){e=a.isArray(e)?e:[e];var d,k,n,j=[],m=[];i=e.length;while(i--){d=e[i];d.to&&j.push({to:d.to,filter:d.filter});(d.from||d.getFrom)&&m.push(d)}i=m.length;while(i--){d=m[i];k=d.filter;n=k?h.find(k).add(a(this).filter(k)):h;n.each(function(){q(l,this,d.getFrom,d.from,f)})}}(!e||j.length)&&h.each(function(){if(!e){var i=b(this,"to");i=i.length;while(i--){d=i[i];if(d.links===declLinkTo){if(d.target===l)return;z(this,d.target,declLinkTo);i.splice(i,1)}}j=declLinkTo;h.each(function(){g(this,a.view(this,f),f,c,c,l)})}A(this,l,j,f)});return h}function q(w,x,t,l,C){var b,d,h,g,j,p,i,B,o,f,A,k=[],c="";l=m((l?l+",":"")+(t?"|,"+t+",":""),e);while(b=l.shift()){g=b.length;j=b.charAt(g-1);b=b.slice(0,-1);switch(j){case":":p=a.trim(b);break;case"[":c=a.trim(b);break;case")":c=c||b;break;case"]":k=[[c,b]];c=c?c+"."+b:b;break;case"\r":i=++b;break;case",":if(b==="|"){B=e;continue}if(i){f=c.slice(i);f=m(f);for(h=0,g=f.length;h<g;h++){d=a.trim(f[h]);j=d.charAt(d.length-1);d=d.slice(0,-1);if(j==="[")f[h]=o=d;else if(j==="]"){k.push([o,d]);f[h]=o?"."+d:d;o=""}}c=c.slice(0,i)+f.join("")+")"}c+=b;A=a.view(x);g=k.length;while(g--){var u=k[g],z=u[1],v=s(w,A,u[0]),y={source:w,target:x,options:C},q=z.split("."),n=v;while(q.length>1){n=n[q.shift()];n&&r(n,y,q.join("."),c,p)}r(v,y,z,c,p,!g&&B)}i=0;k=[];p=c=""}}}function r(d,k,f,m,l,o){var h,i,g=k.target,c=n(g,d),j={attr:l,expr:m};if(c){i=c.paths[f]=c.paths[f]||[];i.push(j);handler=c.handler}else{handler=function(){w.apply(k,arguments)};if(g){h={};h[f]=[j];b(g,"from",e).push({source:d,paths:h,handler:handler})}a(d).bind("propertyChange",handler)}o&&handler({target:d,path:f})}function A(d,f,g,h){var c=function(){y.apply({target:f,links:g,options:h},arguments)};b(d,"to",e).push({target:f,links:g,handler:c});a(d).bind("change",c)}function z(e,g,h){var c,d=b(e,"to"),f=d.length;while(f--){c=d[f];c.target===g&&c.links===h&&a(e).unbind("change",c.handler)}}function n(e,d){var a,c=b(e,"from");l=c.length;while(l--){a=c[l];if(a.source===d)return a}}function E(j,d){var h,f,c,g,e,i;b(d,"to").length&&a(d).unbind("change");f=b(d,"from"),c=f.length;while(c--){h=f[c];a(h.source).unbind("propertyChange",h.handler)}g=b(d,"view");if(c=g.length){e=a.view(d);while(c--){i=g[c];i.parent===e&&e.removeViews(i.index,1)}}}function b(c,e,d){var b=a.data(c,u)||d&&a.data(c,u,{view:[],from:[],to:[]});return b?b[e]:[]}function m(a,h){var c,d=0,b=0,g=f,e=f;a=a.replace(/\s+/g," ");return a.replace(/(\))|([\:\,])|(\')|(\")|([\(\[\{])|([\}\]])/g,function(f,o,n,j,k,m,l,i){if(e){e=!j;return f}if(g){g=!k;return f}if(o)return--b?f:h&&a.charAt(i+1)===","?(c-=d,d=i,f+"\t"+c+"\r\t"):f;if(n)return b?f:(d=i+1,f+"\t");if(m){if(b++)return f;if(f==="(")c=i;return f!=="["?f:"[\t"}if(l)return--b||f!=="]"?f:"]\t";e=j;g=k;return f}).split("\t")}function D(b){return b.type==="checkbox"?b.checked:a(b).val()}var C=a.cleanData;a.extend({view:function(c,m){var d,i,f,k,l,g=document.body;c=c||g;if(!c.nodeType&&!m&&a.isPlainObject(c)){m=c;c=g}if(h&&!h.views.length)d=h;else{while(!(f=b(l=c.parentNode||g,"view")).length){if(!l||c===g){b(g.parentNode,"view",e).push(d=h=new j);break}c=l}if(!d&&c===g)d=f[0];while(!d&&c){if(c.nodeType===8)if(/^\/item|^\/tmpl$/.test(c.nodeValue)){k=f.length;while(k--){i=f[k];if(i.nextNode===c){c=i.prevNode;break}}}else if(/^item|^tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(c.nodeValue)){k=f.length;while(k--){i=f[k];if(i.prevNode===c){d=i;break}}}c=c.previousSibling}d=d||a.view(l)}return d},linkSettings:{getProperty:function(c,b){return a.isFunction(b)?b.call(c):b},linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:D},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,f=a.change,c=a.index,g=a.oldIndex,d=a.items;switch(f){case"insert":b.addViews(c,d);break;case"remove":b.removeViews(c,d.length);break;case"move":b.render();break;case"refresh":b.render()}}return e},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(){var h,f=a.render(this.tmpl,this.data,this.options),b=this.prevNode,e=this.nextNode,d=b.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(b).after(f);d.removeChild(b.nextSibling);d.removeChild(e.previousSibling);g(d,this,this.options,e,0,c,b,0);k(this);return this},addViews:function(h,i,n){var d,f,k=i.length,l=this.views;if(k){if(this.path){d=this.parent;f=p(d.data,d,this.path)[1];f&&d.options}var m=a.render(n||this.tmpl,i,f),b=h?l[h-1].nextNode:this.prevNode,j=b.nextSibling,e=b.parentNode;a(b).after(m);e.removeChild(b.nextSibling);e.removeChild(j.previousSibling);g(e,this,this.options,j,0,c,b,h)}return this},removeViews:function(e,l,m){if(l){var g,j,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||b(d.nextNode.parentNode,"view");f=g.length;while(f--&&j===c)if(g[f]===d)j=f;g.splice(j,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=c;k(d)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setProperty("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}},cleanData:function(b){a(b).each(E);C(b)}});a.fn.extend({view:function(b){return a.view(this[0],b)},addLinks:function(c,b,a){return v(this,c,b,a)},removeLinks:function(){},link:function(e,b,d){if(a.isPlainObject(b))d=b;else{b=a.template(b);b&&this.empty().append(a.render(b,e,d))}return v(this,e,c,d)}});d=a.linkSettings;j.prototype=d.view;F=d.decl;declLinkTo=[{filter:"input["+d.linkToAttr+"]"}]})(jQuery);