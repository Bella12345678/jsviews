/*
 * jQuery Views Plugin v1.0pre
 * Interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string).
 * See JsRender at http://github.com/BorisMoore/jsrender
 * and JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var i,d,v,o={value:"val",html:"html",text:"text"},p="_jsvData",g={change:function(n){var l,k,c,i,h,g,j,m,s,f=this.target,e=n.target,q=a(e),r=this.links,t=r.length;while(t--&&!k){g=r[t];if(g.from&&a(e).is(g.from)){c=g.fromAttr;if(!c){c=d.merge[e.nodeName.toLowerCase()];c=c?c.from.fromAttr:"text"}l=o[c];h=l?q[l]():q.attr(c);if((!this.cb||!(k=this.cb(n)===false))&&h!==b){i=g.to;if(!i){var p=e.getAttribute(d.linkToAttr);if(p){s=/([\$\w\.]+)?(?:\((.*?)\))?(?:\[([\w\.]*)\])(?:\:\s*(\w+)\((.*?)\))?\s*$/;p.replace(s,function(l,b,k,d,c){if(b)f=window[b];else{m=a.view(e);f=m&&m.data||f}i=d;j=c||g.convert})}}if(j=window[j])h=j(h,e,path,f,convertParams);f&&a.observable(f).setField(i,h)}k&&n.stopImmediatePropagation()}}},objectChange:function(m,g){var j,n,e=this,k=e.target,h=a(k),p=m.target,q=e.inner||e.from||e.getFrom,c=e.toAttr,i=e.convert,f=g?g.value:t(p,q),l=g&&g.path,r=a.view(k);if((!e.cb||!(n=e.cb(m,g)===false))&&f!==b&&(!l||l===q)&&(!r||r.onDataChanged(g)!==false)){if(i&&(a.isFunction(i)||(i=window[e.convert])))f=i.call(e,f,p,l,k);if(!c){c=d.merge[k.nodeName.toLowerCase()];c=c?c.to.toAttr:"text"}if(css=c.indexOf("css-")===0&&c.substr(4))h.css(css)!==f&&h.css(css,f);else{j=o[c];if(j&&h[j]()!==f)h[j](f);else h.attr(c)!==f&&h.attr(c,f)}}n&&m.stopImmediatePropagation()},arrayChange:function(e,a){var c,g=this.target,f=a?a.action:d.linkToAttr;if((!this.cb||!(c=this.cb(e,a)===false))&&f!==b)g.onDataChanged(a);c&&e.stopImmediatePropagation()}};function j(h,g,l,b,i,j,d){var f,e,c=this;a.extend(c,{views:[],nodes:h?[]:[document.body],tmpl:l||b&&b.tmpl,path:g,parent:b,prevNode:h});if(b){c.callback=j||b.callback;f=b.views;i.push(c);d=d||b.data;if(a.isArray(b.data)){c.index=e=g;f.splice(e,0,c);viewCount=f.length;d=d[e];while(e++<viewCount-1)a.observable(f[e]).setField("index",e)}else{if(g)d=new Function("$","$view","$data","with($data){ return "+g+";}")(a,b,d);c.index=f.length;f.push(c)}}c.data=d;k(c)}function f(g,p,k,r,w,m,v,s){function t(a,f){var i,d,b=m||p.data;a=a.split(/\:\s*/);if(a[1]){i=a[0];a[0]=a[1]}a=a[0];if(f){d=a;a=f}var c={target:g,toAttr:i,convert:d};a=a.split(/\[|\]/);if(a[1]){b=a[0]==="$view"?h:window[a[0]]||b;a[0]=a[1]}c[this]=a[0];e(b,g,k,c)}var l,x,o,A,z,i,u,y=k===false,h=p,q=w;k=k||p.callback;s=s||0;g=v||g;if(!v&&g.nodeType===1){q++===0&&h.nodes.push(g);n(g.getAttribute(d.getFromAttr),"getFrom",t);n(g.getAttribute(d.linkFromAttr),"from",t);g=g.firstChild}else g=g.nextSibling;while(g&&g!==r){if(g.nodeType===1)f(g,h,k,r,q,m);else if(g.nodeType===8&&(l=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(g.nodeValue)))if(l[1])if(l[2]){h.nextNode=g;h.onCreated(h);h=p}else{h.nextNode=g;h.onCreated(h);return g}else{o=o||c(g.parentNode,"view",true);if(l[2])h=new j(g,s++,b,h,o,k);else{i=a.view(g);if(i&&i.prevNode===g)if(i.data===m)u=i.nextNode;else{i.data=m;i.render();return i.nextNode}else i=new j(g,l[3],l[4],h,o,k,m);g=u||f(g,i,k,r,0)}}else q===0&&h.nodes.push(g);g=g.nextSibling}}function e(p,e,j,o,y){p=h(p);if(a.isFunction(e)){j=e;e=b}else e=h(e);var z,v,k,s,u,w=e,A=this,t=[],n=p[0],i=arguments.length-1;if(!j&&i>2&&a.isFunction(arguments[i])){j=arguments[i];arguments[i]=b}if(!n)return;u=n.nodeType;o=o?a.isArray(o)?o:[o]:[];i=o.length;if(y){if(u){p.each(function(){var a=c(this,"to");if(a.length){a=a[0];if(a===e[0])return;q(this,{target:a,cb:j,links:[{from:"input["+d.linkToAttr+"]"}]})}m(this,{target:e[0],cb:j,links:[{from:"input["+d.linkToAttr+"]"}]})});return}e.each(function(){f(this,a.view(this),j,b,b,n)});return}if(u){(i||j)&&p.each(function(){m(this,{target:e[0],cb:j,links:o})});return}if(i){while(i--){v=o[i];s=v.to;if(s)w=e.find(s).add(a(this).filter(s));w.each(function(){k=a.extend({source:n,target:this,cb:j},v);k.to=b;t.push(k)})}z=g.objectChange;i=t.length;while(i--){k=t[i];var r=n,x=k.getFrom;innerPath=(x||k.from).split("."),innerLinks=[];while(innerPath.length>1){r=r[innerPath.shift()];r&&l(r,a.extend({inner:innerPath.join(".")},k))}l(n,k,x)}return}j&&l(n,{source:n,target:e,cb:j})}function l(e,d,h){var f=d.target,b=function(){g.objectChange.apply(d,arguments)};c(f,"from",true).push({source:e,handler:b,inner:d.inner});a(e).bind("objectChange",b);h&&b({target:e});return b}function m(e,b){var f=b.target,d=function(){g.change.apply(b,arguments)};c(e,"to",true).push(f);a(e).bind("change",d);return d}function q(e,f){var b=c(e,"to"),d=b.length;while(d--)if(b[d]===f.target){a(e).unbind("change");b.splice(d,1)}}function k(b){var e,d=b.data,c=b._onArrayChange;if(c){if(c[1]===d)return;a([c[1]]).unbind("arrayChange",c[0])}if(a.isArray(d)){e=function(){g.arrayChange.apply({target:b,cb:b.callback},arguments)};a([d]).bind("arrayChange",e);b._onArrayChange=[e,d]}}function u(j,d){var h,f,b,g,e,i;c(d,"to").length&&a(d).unbind("change");f=c(d,"from"),b=f.length;while(b--){h=f[b];a(h.source).unbind("objectChange",h.handler)}g=c(d,"view");if(b=g.length){e=a.view(d);while(b--){i=g[b];i.parent===e&&e.removeViews(i.index,1)}}}function c(c,e,d){var b=a.data(c,p)||d&&a.data(c,p,{view:[],from:[],to:[]});return b?b[e]:[]}function n(c,e,f){if(c){var g,h,b,i,a=0,d=c.replace(/(\s*\,\s*)|(\(\s*)|(\s*\))/g,function(b,d,c){return d?a?b:"\r":c?a++?b:"\t":--a?b:"\t"}).split("\r");b=d.length;while(b--)f.apply(e,d[b].split("\t"))}}function h(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function t(a,c){if(a&&c){var b=r(a,c);a=b[0];if(a)return a[b[1]]}return a}function r(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()];return[a,b];rray}return[]}var s=a.cleanData;a.extend({cleanData:function(b){a(b).each(u);s(b)},link:function(g,c,f,d){if(a.isFunction(c)){d=c;c=b}else c=h(c);if(c&&c[0].nodeType)c.each(function(){e(g,this,d,f)});else h(g).each(function(){e(this,c,d,f)})},view:function(b,h){var d,k,f,l,g,e=document.body;b=b||e;if(!b.nodeType&&!h&&a.isPlainObject(b)){h=b;b=e}if(i&&!i.views.length)d=i;else{while(!(f=c(g=b.parentNode||e,"view")).length){if(!g||b===e){c(e.parentNode,"view",true).push(d=i=new j);break}b=g}if(!d&&b===e)d=f[0];while(!d&&b){if(b.nodeType===8&&/^item|tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(b.nodeValue)){l=f.length;while(l--){k=f[l];if(k.prevNode===b){d=k;break}}}b=b.previousSibling}d=d||a.view(g)}return h?a.extend(d,h):d},linkSettings:{linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:"value"},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,g=a.action,c=a.newIndex,e=a.oldIndex,d=a.newItems,f=a.oldItems;switch(g){case"add":b.addViews(c,d);break;case"remove":b.removeViews(e,f.length);break;case"move":b.refresh();break;case"reset":b.refresh()}}return true},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(){var h,g=a.render(this.tmpl,this.data),c=this.prevNode,e=this.nextNode,d=c.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(c).after(g);d.removeChild(c.nextSibling);d.removeChild(e.previousSibling);f(d,this,b,e,0,b,c,0);k(this);return this},addViews:function(e,g,l){var i=g.length,j=this.views;if(i){var k=a.render(l||this.tmpl,g),c=e?j[e-1].nextNode:this.prevNode,h=c.nextSibling,d=c.parentNode;a(c).after(k);d.removeChild(c.nextSibling);d.removeChild(h.previousSibling);f(d,this,b,h,0,b,c,e)}return this},removeViews:function(e,l,m){if(l){var g,j,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||c(d.nextNode.parentNode,"view");f=g.length;while(f--&&j===b)if(g[f]===d)j=f;g.splice(j,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=b;k(d)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setField("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}}});a.fn.extend({view:function(b){return a.view(this[0],b)},link:function(a,c){if(a){e(a,this,c,b,true);e(this,a,c,b,true)}return this},linkFrom:function(a,c,b){e(a,this,b,c);return this},linkTo:function(a,c,b){e(this,a,b,c);return this}});d=a.linkSettings;j.prototype=d.view;v=d.decl})(jQuery);