/*
 * jQuery Views Plugin v1.0pre
 * Interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string).
 * See JsRender at http://github.com/BorisMoore/jsrender
 * and JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var k,c,v,p={value:"val",html:"html",text:"text"},q="_jsvData",o={change:function(n){var l,k,d,i,h,g,j,m,s,f=this.target,e=n.target,q=a(e),r=this.links,t=r.length;while(t--&&!k){g=r[t];if(g.from&&a(e).is(g.from)){d=g.fromAttr;if(!d){d=c.merge[e.nodeName.toLowerCase()];d=d?d.from.fromAttr:"text"}l=p[d];h=l?q[l]():q.attr(d);if((!this.cb||!(k=this.cb(n)===false))&&h!==b){i=g.to;if(!i){var o=e.getAttribute(c.linkToAttr);if(o){s=/([\$\w\.]+)?(?:\((.*?)\))?(?:\[([\w\.]*)\])(?:\:\s*(\w+)\((.*?)\))?\s*$/;o.replace(s,function(l,b,k,d,c){if(b)f=window[b];else{m=a.view(e);f=m&&m.data||f}i=d;j=c||g.convert})}}if(j=window[j])h=j(h,e,path,f,convertParams);f&&a.observable(f).setField(i,h)}k&&n.stopImmediatePropagation()}}},objectChange:function(m,g){var j,n,e=this,k=e.target,h=a(k),o=m.target,q=e.inner||e.from||e.getFrom,d=e.toAttr,i=e.convert,f=g?g.value:u(o,q),l=g&&g.path,r=a.view(k);if((!e.cb||!(n=e.cb(m,g)===false))&&f!==b&&(!l||l===q)&&(!r||r.onDataChanged(g)!==false)){if(i&&(a.isFunction(i)||(i=window[e.convert])))f=i.call(e,f,o,l,k);if(!d){d=c.merge[k.nodeName.toLowerCase()];d=d?d.to.toAttr:"text"}if(css=d.indexOf("css-")===0&&d.substr(4))h.css(css)!==f&&h.css(css,f);else{j=p[d];if(j&&h[j]()!==f)h[j](f);else h.attr(d)!==f&&h.attr(d,f)}}n&&m.stopImmediatePropagation()},arrayChange:function(e,a){var d,g=this.target,f=a?a.action:c.linkToAttr;if((!this.cb||!(d=this.cb(e,a)===false))&&f!==b)g.onDataChanged(a);d&&e.stopImmediatePropagation()}};function l(j,h,l,c,k,i,d){var f,e,b=this;a.extend(b,{views:[],nodes:j?[]:[document.body],tmpl:l||c&&c.tmpl,path:h,parent:c,prevNode:j});if(c){b.callback=i||c.callback;f=c.views;k.push(b);d=d||c.data;if(a.isArray(c.data)){b.index=e=h;f.splice(e,0,b);viewCount=f.length;d=d[e];while(e++<viewCount-1)a.observable(f[e]).setField("index",e)}else{if(h)d=new Function("$","$view","$data","with($data){ return "+h+";}")(a,c,d);b.index=f.length;f.push(b)}}if(a.isArray(d))b._onArrayChange=g("arrayChange",d,{target:b,cb:i});b.data=d}function j(c,e,f){if(c){var g,h,b,i,a=0,d=c.replace(/(\s*\,\s*)|(\(\s*)|(\s*\))/g,function(b,d,c){return d?a?b:"\r":c?a++?b:"\t":--a?b:"\t"}).split("\r");b=d.length;while(b--)f.apply(e,d[b].split("\t"))}}function h(a,m,g,o,t,q,s,p){function r(b,i){var j,h,c=q||m.data;b=b.split(/\:\s*/);if(b[1]){j=b[0];b[0]=b[1]}b=b[0];if(i){h=b;b=i}var d={target:a,toAttr:j,convert:h};b=b.split(/\[|\]/);if(b[1]){c=b[0]==="$view"?f:window[b[0]]||c;b[0]=b[1]}d[this]=b[0];e(c,a,g,d)}var i,u,k,x,w,v=g===false,f=m,n=t;g=g||m.callback;p=p||0;a=s||a;if(!s&&a.nodeType===1){n++===0&&f.nodes.push(a);j(a.getAttribute(c.getFromAttr),"getFrom",r);j(a.getAttribute(c.linkFromAttr),"from",r);a=a.firstChild}else a=a.nextSibling;while(a&&a!==o){if(a.nodeType===1)h(a,f,g,o,n,q);else if(a.nodeType===8&&(i=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(a.nodeValue)))if(i[1])if(i[2]){f.nextNode=a;f.onCreated(f);f=m}else{f.nextNode=a;f.onCreated(f);return a}else{k=k||d(a.parentNode,"view",true);if(i[2])f=new l(a,p++,b,f,k,g);else a=h(a,new l(a,i[3],i[4],f,k,g,q),g,o,0)}else n===0&&f.nodes.push(a);a=a.nextSibling}}function m(d,h,i){function k(a,g){var b=h.data;a=a.split(/\:\s*/);if(a[1]){attr=a[0];a[0]=a[1]}a=a[0];if(g){convert=a;a=g}var c={target:d};a=a.split(/\[|\]/);if(a[1]){b=a[0]==="$view"?f:window[a[0]]||b;a[0]=a[1]}c.from=a[0];e(b,d,false,c)}var g,n,l,p,o,f=h;i=i||0;if(d.nodeType===1){j(d.getAttribute(c.getFromAttr),b,k);j(d.getAttribute(c.linkFromAttr),b,k);d=d.firstChild}else d=d.nextSibling;while(d){if(d.nodeType===1)m(d,f);else if(d.nodeType===8&&(g=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(d.nodeValue)))if(g[1])if(g[2])f=h;else{f.parent.removeViews(f.index,1,true);return d}else if(g[2])f=f.views[i++];else d=m(d,a.view(d),0);d=d.nextSibling}}function d(c,e,d){var b=a.data(c,q)||d&&a.data(c,q,{view:[],from:[],to:[]});return b?b[e]:[]}function f(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function u(a,c){if(a&&c){var b=s(a,c);a=b[0];if(a)return a[b[1]]}return a}function s(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()];return[a,b]}return[]}function g(e,a,b,h,i){if(!h){var g=b.target,c=function(){o[e].apply(b,arguments)};d(g,"from",true).push({source:a,handler:c,inner:b.inner});d(a,"to",true).push(g);f(a).bind(e,c);i&&c({target:a});return c}n(a,b.target)}function e(n,e,d,k,u){n=f(n);if(a.isFunction(e)){d=e;e=b}else e=f(e);var v,s,j,q,r,l=d===false;targetElems=e,eventType="objectChange",addedLinks=[],fromOb=n[0],i=arguments.length-1;if(!d&&i>2&&a.isFunction(arguments[i])){d=arguments[i];arguments[i]=b}if(!fromOb)return;r=fromOb.nodeType;k=k?a.isArray(k)?k:[k]:[];i=k.length;if(u)if(r)n.each(function(){g("change",this,{target:e[0],cb:d,links:[{from:"input["+c.linkToAttr+"]"}]},l)});else e.each(function(){if(l)m(this,a.view(this),fromOb);else h(this,a.view(this),d,b,b,fromOb)});else if(r)(i||d)&&n.each(function(){g("change",this,{target:e[0],cb:d,links:k},l)});else if(i){while(i--){s=k[i];q=s.to;if(q)targetElems=e.find(q).add(a(this).filter(q));targetElems.each(function(){j=a.extend({source:fromOb,target:this,cb:d},s);j.to=b;addedLinks.push(j)})}v=o[eventType];i=addedLinks.length;while(i--){j=addedLinks[i];var p=fromOb,t=j.getFrom;innerPath=(t||j.from).split("."),innerLinks=[];while(innerPath.length>1){p=p[innerPath.shift()];p&&g(eventType,p,a.extend({inner:innerPath.join(".")},j),l)}g(eventType,fromOb,j,l,t)}}else d&&g(eventType,fromOb,{source:fromOb,target:e,cb:d},l)}function n(i,g){var j,o,n,q,p,c,h,r,b,e,l,k,m;if(g&&g.nodeType){c=d(g,"from"),b=c.length;while(b--){j=c[b];if(!i||j.source===i){f(o=j.source).unbind("objectChange",j.handler);c.splice(b,1);e=d(o,"to"),h=e.length;while(h--)e[h]===g&&e.splice(h,1)}}l=d(g,"view");if(b=l.length){k=a.view(g);while(b--){m=l[b];m.parent===k&&k.removeViews(m.index,1)}}}if(i&&i.nodeType){e=d(i,"to"),b=e.length;while(b--){n=e[b];if(!g||n===g){f(i).unbind("change");e.splice(b,1);c=d(n,"from"),h=c.length;while(h--)c[h].source===i&&c.splice(h,1)}}}}function r(c,a){n(a);n(b,a)}var t=a.cleanData;a.extend({cleanData:function(b){a(b).each(r);t(b)},link:function(h,c,g,d){if(a.isFunction(c)){d=c;c=b}else c=f(c);if(c&&c[0].nodeType)c.each(function(){e(h,this,d,g)});else f(h).each(function(){e(this,c,d,g)})},view:function(b,h){var c,i,f,j,g,e=document.body;b=b||e;if(!b.nodeType&&!h&&a.isPlainObject(b)){h=b;b=e}if(k&&!k.views.length)c=k;else{while(!(f=d(g=b.parentNode||e,"view")).length){if(!g||b===e){d(e.parentNode,"view",true).push(c=k=new l);break}b=g}if(!c&&b===e)c=f[0];while(!c&&b){if(b.nodeType===8&&/^item|tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(b.nodeValue)){j=f.length;while(j--){i=f[j];if(i.prevNode===b){c=i;break}}}b=b.previousSibling}c=c||a.view(g)}return h?a.extend(c,h):c},linkSettings:{linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:"value"},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,g=a.action,c=a.newIndex,e=a.oldIndex,d=a.newItems,f=a.oldItems;switch(g){case"add":b.addViews(c,d);break;case"remove":b.removeViews(e,f.length);break;case"move":b.refresh();break;case"reset":b.refresh()}}return true},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(){var f=a.render(this.tmpl,this.data),c=this.prevNode,e=this.nextNode,d=c.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(c).after(f);d.removeChild(c.nextSibling);d.removeChild(e.previousSibling);h(d,this,b,e,0,b,c,this.index);return this},addViews:function(e,f,l){var i=f.length,j=this.views;if(i){var k=a.render(l||this.tmpl,f),c=e?j[e-1].nextNode:this.prevNode,g=c.nextSibling,d=c.parentNode;a(c).after(k);d.removeChild(c.nextSibling);d.removeChild(g.previousSibling);h(d,this,b,g,0,b,c,e)}return this},removeViews:function(e,l,m){if(l){var h,k,j=this.views,n=e+l;while(n-->e){var c=j[n],g=c.views.length,i=c.prevNode,p=c.nextNode,o=[i];g&&c.removeViews(0,g,m);h=h||d(c.nextNode.parentNode,"view");g=h.length;while(g--&&k===b)if(h[g]===c)k=g;h.splice(k,1);if(!m){while(i!==p){i=i.nextSibling;o.push(i)}a(o).remove()}c._onArrayChange&&f(c.data).unbind("arrayChange",c._onArrayChange)}j.splice(e,l);viewCount=j.length;while(e<viewCount)a.observable(j[e]).setField("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}}});a.fn.extend({view:function(b){return a.view(this[0],b)},link:function(c,a){e(c,this,a,b,true);e(this,c,a,b,true);return this},unlink:function(a){if(a){e(a,this,false,b,true);e(this,a,false,b,true)}else this.each(r);return this},linkFrom:function(a,c,b){e(a,this,b,c);return this},linkTo:function(a,c,b){e(this,a,b,c);return this}});c=a.linkSettings;l.prototype=c.view;v=c.decl})(jQuery);