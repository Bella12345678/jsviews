/*
 * jQuery Views Plugin v1.0pre
 * Interactive data-driven views, based on integration between jQuery Templates and jQuery Data Link.
 * Requires jquery.render.js (optimized version of jQuery Templates, for rendering to string).
 * See JsRender at http://github.com/BorisMoore/jsrender
 * and JsViews at http://github.com/BorisMoore/jsviews
 */
(function(a,b){var i,d,w,p={value:"val",html:"html",text:"text"},q="_jsvData",g={change:function(k){var n,m,c,j,g,i,h,l,o,u,e=this.target,f=k.target,s=a(f),t=this.links,q=this.options.beforeChange,v=t.length;while(v--&&!m){i=t[v];if(!i.from||i.from&&a(f).is(i.from)){c=i.fromAttr;if(!c){c=d.merge[f.nodeName.toLowerCase()];c=c?c.from.fromAttr:"text"}n=p[c];g=a.isFunction(c)?c(f):n?s[n]():s.attr(c);if((!q||!(m=q(k)===false))&&g!==b){j=i.to;if(!j){var r=f.getAttribute(d.linkToAttr);if(r){u=/([\$\w\.]+)?(?:\((.*?)\))?(?:\[([\w\.]*)\])(?:\:\s*(\w+)\((.*?)\))?\s*$/;r.replace(u,function(m,b,k,g,d,c){if(b)e=window[b];else{o=a.view(f);e=o&&o.data||e}j=g;h=d||i.convert;l=c})}}if(h)if(e[h])g=e[h].call(e,g,f,j,e,l);else if(h=window[h])g=h(g,f,j,e,l);e&&a.observable(e).setProperty(j,g);this.options.afterChange&&this.options.afterChange(k)}m&&k.stopImmediatePropagation()}}},objectChange:function(l,g){var j,s,f=this,k=f.target,i=a(k),q=l.target,u=f.inner||f.from||f.getFrom,e=f.toAttr,c=g?g.value:t(q,u),n=g&&g.path,o=f.options,r=o.beforeChange,v=a.view(k);if((!r||!(s=r.call(this,l,g)===false))&&c!==b&&(!n||n===u)&&(!v||v.onDataChanged(g)!==false)){var h=f.convert;if(h)if(a.isFunction(h))c=h.call(f,c,q,n,k);else if(h=m(q,f.convert)||m(window,f.convert))c=h[0][h[1]].call(h[0],c);if(!e){e=d.merge[k.nodeName.toLowerCase()];e=e?e.to.toAttr:"text"}if(css=e.indexOf("css-")===0&&e.substr(4))i.css(css)!==c&&i.css(css,c);else{j=p[e];if(j&&i[j]()!==c)i[j](c);else i.attr(e)!==c&&i.attr(e,c)}o.afterChange&&o.afterChange.call(this,l,g)}s&&l.stopImmediatePropagation()},arrayChange:function(c,a){var f,h=this.target,e=this.options.beforeChange,g=a?a.change:d.linkToAttr;if((!e||!(f=e(c,a)===false))&&g!==b){h.onDataChanged(a);this.options.afterChange&&this.options.afterChange(c,a)}f&&c.stopImmediatePropagation()}};function j(h,g,j,b,i,l,d){var f,e,c=this;a.extend(c,{views:[],nodes:h?[]:[document.body],tmpl:j||b&&b.tmpl,path:g,parent:b,prevNode:h});if(b){c.options=l||b.options;f=b.views;i.push(c);d=d||b.data;if(a.isArray(b.data)){c.index=e=g;f.splice(e,0,c);viewCount=f.length;d=d[e];while(e++<viewCount-1)a.observable(f[e]).setProperty("index",e)}else{if(g)d=new Function("$","$view","$data","with($data){ return "+g+";}")(a,b,d);c.index=f.length;f.push(c)}}c.data=d;k(c)}function f(g,p,k,r,w,m,v,s){function t(a,f){var i,d,b=m||p.data;a=a.split(/\:\s*/);if(a[1]){i=a[0];a[0]=a[1]}a=a[0];if(f){d=a;a=f}var c={target:g,toAttr:i,convert:d};a=a.split(/\[|\]/);if(a[1]){b=a[0]==="$view"?h:window[a[0]]||b;a[0]=a[1]}c[this]=a[0];e(b,g,c,false,k)}var l,x,n,z,y,i,u,h=p,q=w;k=k||p.options;s=s||0;g=v||g;if(!v&&g.nodeType===1){q++===0&&h.nodes.push(g);o(g.getAttribute(d.getFromAttr),"getFrom",t);o(g.getAttribute(d.linkFromAttr),"from",t);g=g.firstChild}else g=g.nextSibling;while(g&&g!==r){if(g.nodeType===1)f(g,h,k,r,q,m);else if(g.nodeType===8&&(l=/^(\/?)(?:(item)|(?:tmpl(?:\((.*)\))?(?:\s+([^\s]+))?))$/.exec(g.nodeValue)))if(l[1])if(l[2]){h.nextNode=g;h.onCreated(h);h=p}else{h.nextNode=g;h.onCreated(h);return g}else{n=n||c(g.parentNode,"view",true);if(l[2])h=new j(g,s++,b,h,n,k);else{i=a.view(g);if(i&&i.prevNode===g)if(i.data===m)u=i.nextNode;else{i.data=m;i.render();return i.nextNode}else i=new j(g,l[3],l[4],h,n,k,m);g=u||f(g,i,k,r,0)}}else q===0&&h.nodes.push(g);g=g.nextSibling}}function e(p,i,m,z,e){e=e||{};p=h(p);if(a.isFunction(i)){e.beforeChange=i;i=b}else i=h(i);var A,v,j,s,u,x=i,B=this,t=[],w=e.beforeChange,k=p[0],o=arguments.length-1;if(!w&&e&&a.isFunction(e))w=e.beforeChange=e;if(!k)return;u=k.nodeType;m=m?a.isArray(m)?m:[m]:[];o=m.length;if(z){if(u){p.each(function(){var a=c(this,"to");if(a.length){a=a[0];if(a===i[0])return;r(this,{target:a,options:e,links:[{from:"input["+d.linkToAttr+"]"}]})}n(this,{target:i[0],options:e,links:[{from:"input["+d.linkToAttr+"]"}]})});return}i.each(function(){f(this,a.view(this),e,b,b,k)});return}if(u){(o||e.beforeChange)&&p.each(function(){n(this,{target:i[0],options:e,links:m})});return}if(o){while(o--){v=m[o];s=v.to;if(s)x=i.find(s).add(a(this).filter(s));x.each(function(){j=a.extend({source:k,target:this,options:e},v);j.to=b;t.push(j)})}A=g.objectChange;o=t.length;while(o--){j=t[o];var q=k,y=j.getFrom;innerPath=(y||j.from).split("."),innerLinks=[];while(innerPath.length>1){q=q[innerPath.shift()];q&&l(q,a.extend({inner:innerPath.join(".")},j))}l(k,j,y)}return}e.beforeChange&&l(k,{source:k,target:i,options:e})}function l(e,d,h){var f=d.target,b=function(){g.objectChange.apply(d,arguments)};c(f,"from",true).push({source:e,handler:b,inner:d.inner});a(e).bind("propertyChange",b);h&&b({target:e});return b}function n(e,b){var f=b.target,d=function(){g.change.apply(b,arguments)};c(e,"to",true).push(f);a(e).bind("change",d);return d}function r(e,f){var b=c(e,"to"),d=b.length;while(d--)if(b[d]===f.target){a(e).unbind("change");b.splice(d,1)}}function k(b){var e,d=b.data,c=b._onArrayChange;if(c){if(c[1]===d)return;a([c[1]]).unbind("arrayChange",c[0])}if(a.isArray(d)){e=function(){g.arrayChange.apply({target:b,options:b.options},arguments)};a([d]).bind("arrayChange",e);b._onArrayChange=[e,d]}}function v(j,d){var h,f,b,g,e,i;c(d,"to").length&&a(d).unbind("change");f=c(d,"from"),b=f.length;while(b--){h=f[b];a(h.source).unbind("propertyChange",h.handler)}g=c(d,"view");if(b=g.length){e=a.view(d);while(b--){i=g[b];i.parent===e&&e.removeViews(i.index,1)}}}function c(c,e,d){var b=a.data(c,q)||d&&a.data(c,q,{view:[],from:[],to:[]});return b?b[e]:[]}function o(c,e,f){if(c){var g,h,b,i,a=0,d=c.replace(/(\s*\,\s*)|(\(\s*)|(\s*\))/g,function(b,d,c){return d?a?b:"\r":c?a++?b:"\t":--a?b:"\t"}).split("\r");b=d.length;while(b--)f.apply(e,d[b].split("\t"))}}function h(b){return b instanceof a?b:a.isArray(b)?a([b]):a(b)}function t(b,e){if(b&&e){var c,d=m(b,e);b=d&&d[0];if(b){c=b[d[1]];return a.isFunction(c)?c.call(b):c}}return b}function m(a,b){if(a&&b){var c=b.split(".");b=c.pop();while(a&&c.length)a=a[c.shift()]}return a&&a[b]&&[a,b]}function u(b){return b.type==="checkbox"?b.checked:a(b).val()}var s=a.cleanData;a.extend({cleanData:function(b){a(b).each(v);s(b)},link:function(g,c,f,d){d=d||{};if(a.isFunction(c)){d.beforeChange=c;c=b}else c=h(c);if(c&&c[0].nodeType)c.each(function(){e(g,this,f,false,d)});else h(g).each(function(){e(this,c,f,false,d)})},view:function(b,h){var d,k,f,l,g,e=document.body;b=b||e;if(!b.nodeType&&!h&&a.isPlainObject(b)){h=b;b=e}if(i&&!i.views.length)d=i;else{while(!(f=c(g=b.parentNode||e,"view")).length){if(!g||b===e){c(e.parentNode,"view",true).push(d=i=new j);break}b=g}if(!d&&b===e)d=f[0];while(!d&&b){if(b.nodeType===8&&/^item|tmpl(\([\w\.]*\))?(\s+[^\s]+)?$/.test(b.nodeValue)){l=f.length;while(l--){k=f[l];if(k.prevNode===b){d=k;break}}}b=b.previousSibling}d=d||a.view(g)}return h?a.extend(d,h):d},linkSettings:{linkToAttr:"data-to",linkFromAttr:"data-from",getFromAttr:"data-getfrom",merge:{input:{from:{fromAttr:u},to:{toAttr:"value"}}},view:{onDataChanged:function(a){if(a){var b=this,e=a.change,c=a.index,f=a.oldIndex,d=a.items;switch(e){case"insert":b.addViews(c,d);break;case"remove":b.removeViews(c,d.length);break;case"move":b.render();break;case"refresh":b.render()}}return true},onCreated:function(a){if(this.parent)this.parent.onCreated(a)},render:function(){var h,g=a.render(this.tmpl,this.data),c=this.prevNode,e=this.nextNode,d=c.parentNode;a(this.nodes).remove();this.removeViews(0,this.views.length);this.nodes=[];a(c).after(g);d.removeChild(c.nextSibling);d.removeChild(e.previousSibling);f(d,this,b,e,0,b,c,0);k(this);return this},addViews:function(e,g,l){var i=g.length,j=this.views;if(i){var k=a.render(l||this.tmpl,g),c=e?j[e-1].nextNode:this.prevNode,h=c.nextSibling,d=c.parentNode;a(c).after(k);d.removeChild(c.nextSibling);d.removeChild(h.previousSibling);f(d,this,b,h,0,b,c,e)}return this},removeViews:function(e,l,m){if(l){var g,j,i=this.views,n=e+l;while(n-->e){var d=i[n],f=d.views.length,h=d.prevNode,p=d.nextNode,o=[h];f&&d.removeViews(0,f,m);g=g||c(d.nextNode.parentNode,"view");f=g.length;while(f--&&j===b)if(g[f]===d)j=f;g.splice(j,1);if(!m){while(h!==p){h=h.nextSibling;o.push(h)}a(o).remove()}d.data=b;k(d)}i.splice(e,l);viewCount=i.length;while(e<viewCount)a.observable(i[e]).setProperty("index",e++)}return this},each:function(a){a(this);var b=this.views.length;while(b--)this.views[b].each(a);return this},view:function(b){return a.extend(view,b)},content:function(b){return b?a(b,this.nodes):a(this.nodes)}}}});a.fn.extend({view:function(b){return a.view(this[0],b)},link:function(a,c){if(a){e(a,this,b,true,c);e(this,a,b,true,c)}return this},linkFrom:function(a,c,b){e(a,this,c,false,b);return this},linkTo:function(a,c,b){e(this,a,c,false,b);return this}});d=a.linkSettings;j.prototype=d.view;w=d.decl})(jQuery);